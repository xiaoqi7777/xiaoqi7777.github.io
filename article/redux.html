<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>redux | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.eab45adb.css" as="style"><link rel="preload" href="/assets/js/app.2d5a21ba.js" as="script"><link rel="preload" href="/assets/js/23.9be9c45e.js" as="script"><link rel="prefetch" href="/assets/js/10.8a362e98.js"><link rel="prefetch" href="/assets/js/11.d74a0997.js"><link rel="prefetch" href="/assets/js/12.e2a162e2.js"><link rel="prefetch" href="/assets/js/13.84c6fa39.js"><link rel="prefetch" href="/assets/js/14.c4eac9aa.js"><link rel="prefetch" href="/assets/js/15.6e106e89.js"><link rel="prefetch" href="/assets/js/16.9e29e9f1.js"><link rel="prefetch" href="/assets/js/17.9b3a8933.js"><link rel="prefetch" href="/assets/js/18.f0190824.js"><link rel="prefetch" href="/assets/js/19.9e8ce3c8.js"><link rel="prefetch" href="/assets/js/2.39847600.js"><link rel="prefetch" href="/assets/js/20.f1e6b579.js"><link rel="prefetch" href="/assets/js/21.f06a428f.js"><link rel="prefetch" href="/assets/js/22.e8fff36c.js"><link rel="prefetch" href="/assets/js/24.b1a2e86a.js"><link rel="prefetch" href="/assets/js/25.2721ff74.js"><link rel="prefetch" href="/assets/js/26.2cca1f22.js"><link rel="prefetch" href="/assets/js/27.60ac312a.js"><link rel="prefetch" href="/assets/js/28.a51bcc0b.js"><link rel="prefetch" href="/assets/js/29.d4d7922b.js"><link rel="prefetch" href="/assets/js/3.e8366ca8.js"><link rel="prefetch" href="/assets/js/30.284529e8.js"><link rel="prefetch" href="/assets/js/31.329482e5.js"><link rel="prefetch" href="/assets/js/32.1dd41dba.js"><link rel="prefetch" href="/assets/js/33.cdaf88aa.js"><link rel="prefetch" href="/assets/js/34.d2260297.js"><link rel="prefetch" href="/assets/js/35.0f100cdc.js"><link rel="prefetch" href="/assets/js/36.2d7b8183.js"><link rel="prefetch" href="/assets/js/37.58e42fab.js"><link rel="prefetch" href="/assets/js/38.b702c8f5.js"><link rel="prefetch" href="/assets/js/39.82cf90ef.js"><link rel="prefetch" href="/assets/js/4.f13a62f3.js"><link rel="prefetch" href="/assets/js/40.5e523f7a.js"><link rel="prefetch" href="/assets/js/41.bdd3935e.js"><link rel="prefetch" href="/assets/js/42.38f97d1a.js"><link rel="prefetch" href="/assets/js/43.fde099dd.js"><link rel="prefetch" href="/assets/js/44.1c37dd97.js"><link rel="prefetch" href="/assets/js/45.98b02b2e.js"><link rel="prefetch" href="/assets/js/46.42f3fcd7.js"><link rel="prefetch" href="/assets/js/47.e82a83b5.js"><link rel="prefetch" href="/assets/js/48.198aa16b.js"><link rel="prefetch" href="/assets/js/49.584f6640.js"><link rel="prefetch" href="/assets/js/5.1ee23f75.js"><link rel="prefetch" href="/assets/js/50.8b31f4da.js"><link rel="prefetch" href="/assets/js/51.78f5d0ad.js"><link rel="prefetch" href="/assets/js/52.31174a6a.js"><link rel="prefetch" href="/assets/js/53.077bd356.js"><link rel="prefetch" href="/assets/js/54.3de7f928.js"><link rel="prefetch" href="/assets/js/55.3ad4df39.js"><link rel="prefetch" href="/assets/js/56.785eabef.js"><link rel="prefetch" href="/assets/js/57.8b4691e9.js"><link rel="prefetch" href="/assets/js/58.f7997b54.js"><link rel="prefetch" href="/assets/js/59.d7a4d8a8.js"><link rel="prefetch" href="/assets/js/6.705f6278.js"><link rel="prefetch" href="/assets/js/60.ddb9f94c.js"><link rel="prefetch" href="/assets/js/61.26981a47.js"><link rel="prefetch" href="/assets/js/62.3f032d2a.js"><link rel="prefetch" href="/assets/js/63.39527714.js"><link rel="prefetch" href="/assets/js/64.8868dd89.js"><link rel="prefetch" href="/assets/js/65.6b974d81.js"><link rel="prefetch" href="/assets/js/66.855c5823.js"><link rel="prefetch" href="/assets/js/67.31e1762e.js"><link rel="prefetch" href="/assets/js/68.8c46b6ac.js"><link rel="prefetch" href="/assets/js/69.86ace7af.js"><link rel="prefetch" href="/assets/js/7.1fd1c381.js"><link rel="prefetch" href="/assets/js/70.351ae70a.js"><link rel="prefetch" href="/assets/js/71.1d26e844.js"><link rel="prefetch" href="/assets/js/72.1df64755.js"><link rel="prefetch" href="/assets/js/73.090c6271.js"><link rel="prefetch" href="/assets/js/74.5788c180.js"><link rel="prefetch" href="/assets/js/75.74f8c6f5.js"><link rel="prefetch" href="/assets/js/76.7e7562cd.js"><link rel="prefetch" href="/assets/js/77.777397ae.js"><link rel="prefetch" href="/assets/js/78.d7cc5ce5.js"><link rel="prefetch" href="/assets/js/79.d294b892.js"><link rel="prefetch" href="/assets/js/8.60fbcf9b.js"><link rel="prefetch" href="/assets/js/80.99fd18d4.js"><link rel="prefetch" href="/assets/js/81.2c0e2273.js"><link rel="prefetch" href="/assets/js/9.c9c66d36.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eab45adb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>article</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/webpack.html" class="sidebar-link">webpack(基础)</a></li><li><a href="/article/module.html" class="sidebar-link">module</a></li><li><a href="/article/vueAnalysis.html" class="sidebar-link">vue</a></li><li><a href="/article/vueN.html" class="sidebar-link">vue</a></li><li><a href="/article/promise.html" class="sidebar-link">promise &amp;&amp; Event Loop</a></li><li><a href="/article/wx.html" class="sidebar-link">微信公众号</a></li><li><a href="/article/frontModle.html" class="sidebar-link">发布订阅模式&amp;&amp;观察者模式</a></li><li><a href="/article/vuePlugin.html" class="sidebar-link">vuePlugin</a></li><li><a href="/article/jwtPrinciple.html" class="sidebar-link">jwt</a></li><li><a href="/article/routerAuth.html" class="sidebar-link">routerAuth</a></li><li><a href="/article/statusCode.html" class="sidebar-link">常用的状态码</a></li><li><a href="/article/koa_express.html" class="sidebar-link">koa&amp;&amp;express</a></li><li><a href="/article/useLibrary.html" class="sidebar-link">常用库</a></li><li><a href="/article/reg.html" class="sidebar-link">正则</a></li><li><a href="/article/deepWebpack.html" class="sidebar-link">webpack(深)</a></li><li><a href="/article/ts.html" class="sidebar-link">ts</a></li><li><a href="/article/wqianduan.html" class="sidebar-link">微前端</a></li><li><a href="/article/vue3.html" class="sidebar-link">vue3</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>react</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/react.html" class="sidebar-link">react</a></li><li><a href="/article/redux.html" class="active sidebar-link">redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/redux.html#react-redux-用法" class="sidebar-link">react-redux 用法</a></li><li class="sidebar-sub-header"><a href="/article/redux.html#react-redux-原理" class="sidebar-link">react-redux 原理</a></li><li class="sidebar-sub-header"><a href="/article/redux.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/article/redux.html#persist" class="sidebar-link">persist</a></li><li class="sidebar-sub-header"><a href="/article/redux.html#saga-base" class="sidebar-link">saga base</a></li><li class="sidebar-sub-header"><a href="/article/redux.html#hand-saga" class="sidebar-link">hand saga</a></li></ul></li><li><a href="/article/reactRouter.html" class="sidebar-link">react-router</a></li><li><a href="/article/dva.html" class="sidebar-link">dva</a></li><li><a href="/article/hook.html" class="sidebar-link">hooks</a></li><li><a href="/article/reactSource.html" class="sidebar-link">react source</a></li><li><a href="/article/fiber.html" class="sidebar-link">fiber</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/vueSource.html" class="sidebar-link">vue source</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>axios</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/axios.html" class="sidebar-link">axios</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>upload</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/upload.html" class="sidebar-link">upload</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>binary</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/binary.html" class="sidebar-link">二进制</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>monitor</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/monitor.html" class="sidebar-link">监控</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="redux"><a href="#redux" aria-hidden="true" class="header-anchor">#</a> redux</h1> <p></p><div class="table-of-contents"><ul><li><a href="#react-redux-用法">react-redux 用法</a></li><li><a href="#react-redux-原理">react-redux 原理</a><ul><li><a href="#createstore">createStore</a></li><li><a href="#applymiddleware">applyMiddleware</a></li><li><a href="#compose">compose</a></li><li><a href="#bindactioncreators">bindActionCreators</a></li><li><a href="#combinereducers">combineReducers</a></li></ul></li><li><a href="#中间件">中间件</a><ul><li><a href="#logger">logger</a></li><li><a href="#redux-thunk">redux-thunk</a></li><li><a href="#redux-promise">redux-promise</a></li></ul></li><li><a href="#persist">persist</a></li><li><a href="#saga-base">saga base</a><ul><li><a href="#base-hand">base-hand</a></li><li><a href="#take">take</a></li><li><a href="#put">put</a></li><li><a href="#fork">fork</a></li><li><a href="#takeevery">takeEvery</a></li><li><a href="#call-支持promise异步">call &amp;&amp; 支持promise异步</a></li><li><a href="#delay">delay</a></li><li><a href="#cps">cps</a></li><li><a href="#all">all</a></li><li><a href="#cannel">cannel</a></li></ul></li><li><a href="#hand-saga">hand saga</a><ul><li><a href="#saga-index">saga/index</a></li><li><a href="#saga-effect">saga/effect</a></li></ul></li></ul></div><p></p> <h2 id="react-redux-用法"><a href="#react-redux-用法" aria-hidden="true" class="header-anchor">#</a> react-redux 用法</h2> <ul><li>首先会创建一个仓库,仓库会返回getState(获取最新的state),dispatch(他接收一个action 修改当前最新的state),subscribe(注入的函数 等待dispatch执行后 会执行的函数)</li> <li>当按键触发的时候 调用store.dispatch()传入action是一个对象格式</li> <li>reducer是处理函数 每一个组件一般都是一个单独的reducer,有多个的时候 用combineReducers进行绑定</li> <li>1、创建仓库</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducer'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> logger <span class="token keyword">from</span> <span class="token string">'logger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reduxThunk <span class="token keyword">from</span> <span class="token string">'redux-thunk'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reduxPromise <span class="token keyword">from</span> <span class="token string">'redux-promise'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span>reduxPromise<span class="token punctuation">,</span>reduxThunk<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
<span class="token comment">// 另一个写法 最终会转换成上面的形式</span>
<span class="token comment">// let store = createStore(reducer,applyMiddleware(logger,reduxPromise,reduxThunk))</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> store<span class="token punctuation">;</span>
</code></pre></div><ul><li>2、创建action(多个,和组件对应)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span>  <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'../action-types'</span>
<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">,</span>payload<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">DECREMENT</span><span class="token punctuation">,</span>payload<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>increment<span class="token punctuation">,</span>decrement<span class="token punctuation">}</span>
</code></pre></div><ul><li>3、创建reducer(多个,和组件对应)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'../action-types'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span><span class="token punctuation">{</span>number<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">INCREMENT2</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>number<span class="token punctuation">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span>action<span class="token punctuation">.</span>payload<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">DECREMENT2</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>number<span class="token punctuation">:</span>state<span class="token punctuation">.</span>number<span class="token operator">-</span>action<span class="token punctuation">.</span>payload<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token punctuation">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>4、创建action-types.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT</span> <span class="token operator">=</span> <span class="token string">'INCREMENT'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DECREMENT</span> <span class="token operator">=</span> <span class="token string">'DECREMENT'</span>
</code></pre></div><ul><li>5、组件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父组件</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Counter1  <span class="token keyword">from</span> <span class="token string">'./counter1'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">class</span> <span class="token class-name">counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Counter1<span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token comment">// 其他的子组件</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> actions <span class="token keyword">from</span> <span class="token string">'./store/actions/counter2'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./store/action-types'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">-</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>counter2
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  actions
<span class="token punctuation">)</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span> 
</code></pre></div><h2 id="react-redux-原理"><a href="#react-redux-原理" aria-hidden="true" class="header-anchor">#</a> react-redux 原理</h2> <ul><li>他提供了2个对象{Provider,connect} 第一个Provider包括父组件 传递store 第二个是connect 将修改state和操作dispatch和当前组件传入进去 进行绑定</li> <li>他内部是用 context api 传递数据的</li> <li>Provider 组件继承 context.Provider 将store 传递下去</li> <li>connect 接收操作state dispatch 还有当前组件和context传递过来的store,在componentDidMount生命周期 通过store.subscribe 订阅state变化 然后将 state action操作 props 绑定到 返回的组件中</li> <li><code>import {ReactReduxContext} from 'react-redux'</code> <code>ReactReduxContext</code>等于<code>connect</code> 他可以获取<code>Provider</code>提供的store参数</li> <li>connect内的代码 其他的简单就没有复制进来</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>bindActionCreators<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../redux'</span>
<span class="token keyword">import</span> Context <span class="token keyword">from</span> <span class="token string">'./Context'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mapStateTopProps<span class="token punctuation">,</span>mapDispatchToProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">InnerComponent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component<span class="token punctuation">{</span>
        <span class="token keyword">static</span> contextType <span class="token operator">=</span> Context <span class="token comment">// this.context = {store:store}</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span>context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">mapStateTopProps</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> mapDispatchToProps <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>actions <span class="token operator">=</span> <span class="token function">mapDispatchToProps</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> mapDispatchToProps <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>actions <span class="token operator">=</span> <span class="token function">bindActionCreators</span><span class="token punctuation">(</span>mapDispatchToProps<span class="token punctuation">,</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>unsubscribe <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token function">mapStateTopProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token operator">&lt;</span>InnerComponent <span class="token punctuation">{</span><span class="token operator">...</span>this<span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>this<span class="token punctuation">.</span>state<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>this<span class="token punctuation">.</span>actions<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><h3 id="createstore"><a href="#createstore" aria-hidden="true" class="header-anchor">#</a> createStore</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">CreateStore</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> state<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">getState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>state<span class="token punctuation">;</span>
  <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// action 是有格式要求的  第一个是纯对象 第二个是 有type属性</span>
  <span class="token keyword">let</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
    listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'@INIT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 订阅的都是 在dispatch后执行的函数</span>
  <span class="token keyword">let</span> <span class="token function-variable function">subscribe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token comment">// 删除自己 返回最新的 listeners</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
      listeners<span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token operator">=&gt;</span>l<span class="token operator">!==</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    getState<span class="token punctuation">,</span>
    dispatch<span class="token punctuation">,</span>
    subscribe
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CreateStore
</code></pre></div><h3 id="applymiddleware"><a href="#applymiddleware" aria-hidden="true" class="header-anchor">#</a> applyMiddleware</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>compose<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./index'</span>
<span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
      <span class="token keyword">let</span> dispatch<span class="token punctuation">;</span>
      <span class="token keyword">let</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">:</span>store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
        <span class="token function-variable function">dispatch</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      middlewares <span class="token operator">=</span>middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token operator">=&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这个dispatch 是包装后的dispatch 函数  当外面调用dispatch的时候 他实际会执行真正的dispatch</span>
      <span class="token comment">// 里面的next就是 实际的dispatch  他会传入action 执行</span>
      dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
      <span class="token comment">// 返回的是包装后的dispatch</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>store<span class="token punctuation">,</span>
        dispatch
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> applyMiddleware
</code></pre></div><h3 id="compose"><a href="#compose" aria-hidden="true" class="header-anchor">#</a> compose</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token parameter">args</span><span class="token operator">=&gt;</span>args<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> fns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="bindactioncreators"><a href="#bindactioncreators" aria-hidden="true" class="header-anchor">#</a> bindActionCreators</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 此方法只能接受一个actionCreator actionCreator是一个函数</span>
<span class="token keyword">function</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span><span class="token parameter">actionCreator<span class="token punctuation">,</span>dispatch</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">actionCreator</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">actionCreators<span class="token punctuation">,</span>dispatch</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> actionCreators <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span>actionCreators<span class="token punctuation">,</span>dispatch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> boundActionCreators <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//bound是bind的过去式 完成式</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> actionCreators<span class="token punctuation">)</span><span class="token punctuation">{</span>
    boundActionCreators<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bindActionCreator</span><span class="token punctuation">(</span>actionCreators<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>dispatch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> boundActionCreators
<span class="token punctuation">}</span>
</code></pre></div><h3 id="combinereducers"><a href="#combinereducers" aria-hidden="true" class="header-anchor">#</a> combineReducers</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// reducer 是从老状态和action中得到新的状态</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> reducers<span class="token punctuation">)</span><span class="token punctuation">{</span>
      nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> nextState
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="中间件"><a href="#中间件" aria-hidden="true" class="header-anchor">#</a> 中间件</h2> <ul><li>格式 连着3个函数,第一个函数接收<code>{getState,dispatch}</code>,第二个接收next 就是dispatch(执行中间件),第三个是action(组件传递进来的一个作用)</li> <li>一般中间件 都是在第三个函数内 对action 进行判断逻辑 处理</li></ul> <h3 id="logger"><a href="#logger" aria-hidden="true" class="header-anchor">#</a> logger</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//代表下一个中间件</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// console.log('action',action)</span>
      <span class="token comment">// console.log(getState())</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token comment">// console.log(getState())</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="redux-thunk"><a href="#redux-thunk" aria-hidden="true" class="header-anchor">#</a> redux-thunk</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// action的用法</span>
<span class="token keyword">function</span> <span class="token function">asyncIncrement</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span>getState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">DECREMENT1</span><span class="token punctuation">,</span>payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//代表下一个中间件 他是实际老的dispatch</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span>getState<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="redux-promise"><a href="#redux-promise" aria-hidden="true" class="header-anchor">#</a> redux-promise</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// action 的用法</span>
<span class="token keyword">function</span> <span class="token function">promiseIncrement</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// actionCreator action的创建函数</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT1</span><span class="token punctuation">,</span>payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//代表下一个中间件 他是实际老的dispatch</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>then<span class="token operator">&amp;&amp;</span><span class="token keyword">typeof</span> action<span class="token punctuation">.</span>then <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>  action<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="persist"><a href="#persist" aria-hidden="true" class="header-anchor">#</a> persist</h2> <ul><li>在2个地方做处理 第一个是index入口文件把组件包裹下,第二个是store把reducer拦截下</li> <li>入口文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>PersistGate<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-persist/integration/react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>persistor<span class="token punctuation">,</span>store<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">class</span> <span class="token class-name">counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>PersistGate persistor<span class="token operator">=</span><span class="token punctuation">{</span>persistor<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Counter<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>PersistGate<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">// PersistGate 的作用就是 调用执行下 this.props.persistor.initState 函数 然后将原来的组件原封不动的返回</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">PersistGate</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 调用persisor的初始化状态的方法 要把local里的数据取出来,合并到状态树中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>persistor<span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>store处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> persistReducer<span class="token punctuation">,</span>persistStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-persist'</span>
<span class="token keyword">import</span> storage <span class="token keyword">from</span> <span class="token string">'redux-persist/lib/storage'</span>
<span class="token keyword">const</span> persistConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// localStorage.setItem('root')</span>
  key<span class="token punctuation">:</span><span class="token string">'root'</span><span class="token punctuation">,</span>
  storage
<span class="token punctuation">}</span>
<span class="token keyword">const</span> persistedReducer <span class="token operator">=</span> <span class="token function">persistReducer</span><span class="token punctuation">(</span>persistConfig<span class="token punctuation">,</span>reducer<span class="token punctuation">)</span>
<span class="token comment">// 中间件的原理 就是 拦截dispatch 做处理</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span>reduxPromise<span class="token punctuation">,</span>reduxThunk<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>persistedReducer<span class="token punctuation">)</span>
<span class="token keyword">let</span> persistor <span class="token operator">=</span> <span class="token function">persistStore</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>persistor<span class="token punctuation">,</span>store<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// persistReducer 他的作用就是模仿一个reducer 然后将之前的reducer包装</span>
<span class="token comment">// 当dispatch({type:'PERSIST_INIT'})就是取值 其他情况的时候就是设置值 页面刚进来的时候 默认就是进入到PERSIST_INIT(后面会dispatch)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">persistConfig<span class="token punctuation">,</span>reducer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//表示是否已经把localStorage里的值取出来赋给仓库状态 </span>
  <span class="token keyword">let</span> initialzed <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>storage<span class="token punctuation">,</span>key<span class="token punctuation">}</span> <span class="token operator">=</span> persistConfig<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'PERSIST_INIT'</span><span class="token punctuation">:</span>
        initialzed <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span>  storage<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
          state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>initialzed<span class="token punctuation">)</span><span class="token punctuation">{</span>
          state<span class="token operator">=</span><span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
          storage<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> state<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// persistStore 的功能就是派发 {type:'PERSIST_INIT'}  </span>
<span class="token comment">// 当页面初始化的时候 会执行PersistGate组件的 initState 方法,此方法对应下面的store.dispatch({type:'PERSIST_INIT'}) </span>
<span class="token comment">// 派发 PERSIST_INIT 的时候 会走 storage.getValue 获取值 所以其他情况的dispatch 修改store.store的时候都触发storage.setValue()</span>
<span class="token keyword">function</span> <span class="token function">persistStore</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> persistor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">,</span>
    <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'PERSIST_INIT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> persistor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="saga-base"><a href="#saga-base" aria-hidden="true" class="header-anchor">#</a> saga base</h2> <h3 id="base-hand"><a href="#base-hand" aria-hidden="true" class="header-anchor">#</a> base-hand</h3> <ul><li><p>saga 是一个函数,执行返回的函数是一个redux中间件,函数有个run方法</p></li> <li><p>run的参数是generator函数,同时这个generator函数,是saga的入口配置文件,配置文件就想一个reducer能操作store</p></li> <li><p>1、点击按钮 派发一个action 他会走中间件,<code>events.emit(action.type,action)</code>他就是一个小拦截的作用,不影响后面的中间件(如果只有next()执行那个会走进入下一个中间件)</p></li> <li><p>2、run是一个函数 他接收的是一个generator函数(是使用saga的一个配置文件,后面再说)。run函数里面的next可以看做一个小的中间件,他是根据generator函数里面的内容执行的。next会自动执行 调用generator里面的 第一个yield。take和put方式 实际就是一个简单的包装,增加了一个type而已,第一个yield执行的时候 返回的type是TAKE,他走了<code>events</code>的订阅,而方法就是当前的next。</p></li> <li><p>3、初始化的时候 订阅了,等点击的时候走到中间,执行<code>events</code>的emit,他会执行之前保存的next,再次执行generator函数,走到配置文件的 yield put函数,他返回的是一个type是一个PUT,就走case 'PUT',执行dispatch,这个dispatch和组件调用dispatch是一样的,同样他会进入到saga中间件 但是执行<code>events.emit</code> 没用,因为此时的action.type没有被订阅,这个是个的dispatch 就是真正的会修改store的。接着执行'put'的next,进入generator的下一个yield。流程就完了</p></li> <li><p>简单的实现原理</p></li> <li><p>redux-saga/index</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">function</span> <span class="token function">sagaMiddleware</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">generator</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span>  <span class="token punctuation">{</span>value<span class="token punctuation">:</span>effect<span class="token punctuation">,</span>done<span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'TAKE'</span><span class="token punctuation">:</span>
              events<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>actionType<span class="token punctuation">,</span>next<span class="token punctuation">)</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>    
            <span class="token keyword">case</span> <span class="token string">'PUT'</span><span class="token punctuation">:</span>
              <span class="token function">dispatch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>action<span class="token punctuation">)</span>
              <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sagaMiddleware<span class="token punctuation">.</span>run <span class="token operator">=</span> run
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'action.type'</span><span class="token punctuation">,</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
        events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sagaMiddleware
<span class="token punctuation">}</span>
</code></pre></div><ul><li>redux-saga/effects</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token parameter">actionType</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span>
   type<span class="token punctuation">:</span><span class="token string">'TAKE'</span><span class="token punctuation">,</span>
   actionType
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'PUT'</span><span class="token punctuation">,</span>
    action
  <span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
</code></pre></div><ul><li>基础用法</li> <li>配置</li> <li>store</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">'../redux-saga'</span>
<span class="token keyword">import</span> rootSaga <span class="token keyword">from</span> <span class="token string">'./rootSaga'</span>
<span class="token operator">+</span> <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">+</span> <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">+</span> sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><ul><li>使用saga的配置文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>takeEvery<span class="token punctuation">,</span>put<span class="token punctuation">,</span>all<span class="token punctuation">,</span>delay<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token comment">// yield 出来的是指令对象 </span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">asyncIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果yield出来了一个 put的返回值,saga中间件会向仓库派发真正的action</span>
  <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 他会监听 他不会 阻塞当前的saga 但是他永远不会结束</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchAsyncIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">,</span>asyncIncrement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">helloSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// saga 入口</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">helloSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">watchAsyncIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>组件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> actions <span class="token keyword">from</span> <span class="token string">'../store/actions/counter'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function-variable function">fn</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11111'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>increment<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">++</span><span class="token operator">++</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token number">1</span>秒后加<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>asyncIncrement<span class="token punctuation">}</span><span class="token operator">&gt;</span>saga<span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  <span class="token parameter">state</span><span class="token operator">=&gt;</span>state<span class="token punctuation">,</span>
  actions
<span class="token punctuation">)</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>
</code></pre></div><ul><li>action-types</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT</span> <span class="token operator">=</span> <span class="token string">'INCREMENT'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ASYNC_INCREMENT</span> <span class="token operator">=</span> <span class="token string">'ASYNC_INCREMENT'</span>
</code></pre></div><h3 id="take"><a href="#take" aria-hidden="true" class="header-anchor">#</a> take</h3> <ul><li>用法 <code>take(types.ASYNC__XX)</code> 用来订阅的 不会执行任何</li> <li>saga 函数第一个是默认执行的 所以上来就先take订阅一下时间。</li> <li>内部执行到take的时候 会触发订阅事件<code>events.once(effect.actionType,next)</code>,中间件执行的时候每次都会执行<code>events.emit(action.type,action)</code>,如果事件对应上 就会触发next(下一个中间件)执行,他会走saga函数的下一个yield函数,所以组件内调用saga函数的types一般和take函数里面的types对应。组件调用一个 saga 函数往下走一次,调用2次 saga 才能走2次yield。他会阻塞进程</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// take 截取部分核心逻辑</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'TAKE'</span><span class="token punctuation">:</span>
    <span class="token comment">// 订阅</span>
    events<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>actionType<span class="token punctuation">,</span>next<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 中间件</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 发布</span>
    events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="put"><a href="#put" aria-hidden="true" class="header-anchor">#</a> put</h3> <ul><li>put 实际就是调用dispatch,他传入的是action(put函数返回的就是包装后的action 带type=put的对象)直接修改状态,同时他还会执行next 调用下一个yield函数,他不会堵塞进程</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// put用法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// put 截取核心逻辑</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'PUT'</span><span class="token punctuation">:</span>
    <span class="token comment">// 订阅</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>action<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fork"><a href="#fork" aria-hidden="true" class="header-anchor">#</a> fork</h3> <ul><li>fork他传入的是一个generator(生成器),会直接执行,还会调用下一个next 不会阻塞进程。启动一个新的进程,然后直接向下执行,(next)返回的就是当前生成器</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// fork就是启动一个新的进程,然后直接向下执行</span>
  <span class="token comment">// task代表当前的任务 increment()</span>
  <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'FORK'</span><span class="token punctuation">:</span>
    <span class="token keyword">let</span> task <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//task==iterator</span>
    <span class="token function">run</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 直接执行下一个next 不堵塞进程</span>
    <span class="token function">next</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="takeevery"><a href="#takeevery" aria-hidden="true" class="header-anchor">#</a> takeEvery</h3> <ul><li>takeEvery 内部开启了一个新的进程,然后在里面进行死循环 执行take</li> <li>effect 里面的<code>takeEvery</code>调用了fork,fork 就是执行了一个新的生成器</li> <li>take进行订阅, 一下中间件监控到相同事件就会触发下一个yield,take会堵塞进程,一旦触发就再次等待</li> <li>task 是takeEvery的第二个参数 一般是一个生成器</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span><span class="token parameter">actionType<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// yield fork一个saga</span>
  <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 死循环 take 等待任务 task执行任务</span>
      <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span>actionType<span class="token punctuation">)</span>
      <span class="token keyword">yield</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="call-支持promise异步"><a href="#call-支持promise异步" aria-hidden="true" class="header-anchor">#</a> call &amp;&amp; 支持promise异步</h3> <ul><li>call 接收的就是一个promise 内部<code>fn.apply(context,args).then(next)</code>then的时候传入next,当promise时间到的时候执行下一个next</li> <li>同样直接执行promise的时候 一样 也是将next传入进去<code>effect.then(next)</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">const</span> <span class="token function-variable function">pro</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">pro</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>pro<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 等待每一个 ASYNC_INCREMENT动作,然后执行 increment函数</span>
  <span class="token comment">// 他不会阻塞saga,直接向后面执行,take会阻塞</span>
  <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">,</span>increment<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 内部call逻辑</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'CALL'</span><span class="token punctuation">:</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>fn<span class="token punctuation">,</span>args<span class="token punctuation">,</span>context<span class="token punctuation">}</span> <span class="token operator">=</span> effect<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// promise逻辑</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> effect<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 支持then</span>
    effect<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      xxxxx
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="delay"><a href="#delay" aria-hidden="true" class="header-anchor">#</a> delay</h3> <ul><li>delay函数 直接调用的是call,在effect可以看到 他就是promise和call结合</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// delay effect</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'CALL'</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span><span class="token punctuation">{</span>fn<span class="token punctuation">:</span>delayP<span class="token punctuation">,</span>args<span class="token punctuation">:</span>args<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">delayP</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="cps"><a href="#cps" aria-hidden="true" class="header-anchor">#</a> cps</h3> <ul><li>cps 是回调函数的用法</li> <li>callback 就是下一个中间件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">const</span> <span class="token function-variable function">fn1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'ms'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">cps</span><span class="token punctuation">(</span>fn1 <span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ms'</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">,</span>increment<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 原理</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'CPS'</span><span class="token punctuation">:</span>
    <span class="token comment">// </span>
    effect<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>effect<span class="token punctuation">.</span>args<span class="token punctuation">,</span>next<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="all"><a href="#all" aria-hidden="true" class="header-anchor">#</a> all</h3> <ul><li>all 会同时启动多个saga,然后等待所有的saga完成后才能结束当前这个saga</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">incrementWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">,</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--loggerlogger'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">loggerWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">ASYNC_INCREMENT</span><span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start saga'</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">incrementWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">loggerWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">loggerWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end saga'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 原理</span>
  <span class="token comment">// 高阶函数 作用的传入一个cb函数和一个number 返回值执行的次数和number相等的时候 就执行cb函数</span>
  <span class="token keyword">function</span> <span class="token function">times</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span>total</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">===</span> total<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 核心逻辑</span>
  <span class="token comment">// fns 就是所有的all([xx,xx])数组里面的生成器</span>
  <span class="token comment">// run(fn,done)循环遍历每一个生成器,同时传入done </span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'ALL'</span><span class="token punctuation">:</span>
    <span class="token keyword">let</span> fns <span class="token operator">=</span> effect<span class="token punctuation">.</span>fns<span class="token punctuation">;</span>
    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">times</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行每一个all数组里面的生成器 times 第一个是参数是cb 等到所有的done执行完的时候,就会触发最有一个done里面的cb函数(next中间件)</span>
    fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">run</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span>done<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> effect<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 即当前的迭代器执行完成的时候  就会进来</span>
      <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="cannel"><a href="#cannel" aria-hidden="true" class="header-anchor">#</a> cannel</h3> <ul><li>取消定时任务</li> <li>fork 开启一个新的进程 task代表的当前的increment进程,是一个无线循环</li> <li>take(types.STOP)开启一个事件订阅,堵塞进程,等到组件按钮发送dispatch(types.STOP),执行cancel,传入task进程,内部执行task.return()就可以停止生成器</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法</span>
<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// fork就是启动一个新的进程,然后直接向下执行</span>
  <span class="token comment">// task代表当前的任务 increment()</span>
  <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token constant">STOP</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">cancel</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 原理</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'CANCEL'</span><span class="token punctuation">:</span>
  effect<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="hand-saga"><a href="#hand-saga" aria-hidden="true" class="header-anchor">#</a> hand saga</h2> <h3 id="saga-index"><a href="#saga-index" aria-hidden="true" class="header-anchor">#</a> saga/index</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token comment">// 高阶函数</span>
<span class="token keyword">function</span> <span class="token function">times</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span>total</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">===</span> total<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// let fn = times(()=&gt;console.log('end'),3) </span>
<span class="token comment">// fn();fn();fn(); 当执行3次 fn()最后才返回callback</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">function</span> <span class="token function">sagaMiddleware</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">generator<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 判断 如果他是一个函数 说明是一个生成器 需要执行返回迭代器 </span>
      <span class="token comment">//      如果不是一个函数 说明本身就是一个迭代器 执行next就可以</span>
      <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token keyword">typeof</span> generator <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>generator<span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// value 可能是正常的effect 也可以是一个iterator</span>
        <span class="token comment">// 如果是 iterator 会让他执行两次next 在走 switch 语句</span>
        <span class="token keyword">let</span>  <span class="token punctuation">{</span>value<span class="token punctuation">:</span>effect<span class="token punctuation">,</span>done<span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'起点'</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span>done<span class="token punctuation">,</span><span class="token string">'it=&gt;'</span><span class="token punctuation">,</span>it<span class="token punctuation">,</span><span class="token string">'action'</span><span class="token punctuation">,</span>action<span class="token punctuation">,</span>effect<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 弄清这个地方 就明白run 第二次的时候 'ALL' 的时候 出现第二次calllback 走下面的情况 了</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> effect<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">{</span>
            effect<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">case</span> <span class="token string">'TAKE'</span><span class="token punctuation">:</span>
                events<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>actionType<span class="token punctuation">,</span>next<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>    
              <span class="token keyword">case</span> <span class="token string">'PUT'</span><span class="token punctuation">:</span>
                <span class="token function">dispatch</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>action<span class="token punctuation">)</span>
                <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">'CALL'</span><span class="token punctuation">:</span>
                <span class="token keyword">let</span> <span class="token punctuation">{</span>fn<span class="token punctuation">,</span>args<span class="token punctuation">,</span>context<span class="token punctuation">}</span> <span class="token operator">=</span> effect<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
                <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">'FORK'</span><span class="token punctuation">:</span>
                <span class="token keyword">let</span> task <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//task==iterator</span>
                <span class="token function">run</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// next中的task会传递给当前的fork返回值</span>
                <span class="token function">next</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">'CANCEL'</span><span class="token punctuation">:</span>
                effect<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">'CPS'</span><span class="token punctuation">:</span>
                effect<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>effect<span class="token punctuation">.</span>args<span class="token punctuation">,</span>next<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">'ALL'</span><span class="token punctuation">:</span>
                <span class="token keyword">let</span> fns <span class="token operator">=</span> effect<span class="token punctuation">.</span>fns<span class="token punctuation">;</span>
                <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">times</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行每一个all数组里面的生成器 times第一个是参数是cb 等到所有的</span>
                fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                  <span class="token function">run</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span>done<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback============'</span><span class="token punctuation">)</span>
            callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sagaMiddleware<span class="token punctuation">.</span>run <span class="token operator">=</span> run
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sagaMiddleware
<span class="token punctuation">}</span>
</code></pre></div><h3 id="saga-effect"><a href="#saga-effect" aria-hidden="true" class="header-anchor">#</a> saga/effect</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token parameter">actionType</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span>
   type<span class="token punctuation">:</span><span class="token string">'TAKE'</span><span class="token punctuation">,</span>
   actionType
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'PUT'</span><span class="token punctuation">,</span>
    action
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'CALL'</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span><span class="token punctuation">{</span>fn<span class="token punctuation">,</span>args<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'CALL'</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span><span class="token punctuation">{</span>fn<span class="token punctuation">:</span>delayP<span class="token punctuation">,</span>args<span class="token punctuation">:</span>args<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cps</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'CPS'</span><span class="token punctuation">,</span>
    fn<span class="token punctuation">,</span>
    args
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">fns</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'ALL'</span><span class="token punctuation">,</span>
    fns  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delayP</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'FORK'</span><span class="token punctuation">,</span>
    task<span class="token comment">// task 也是一个生成器</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'CANCEL'</span><span class="token punctuation">,</span>  
    task
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 类似开启了一个新的进程,然后在进程里面进行死循环 执行take iterator</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span><span class="token parameter">actionType<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// yield fork一个saga</span>
  <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 死循环 take 等待任务 task执行任务</span>
      <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span>actionType<span class="token punctuation">)</span>
      <span class="token keyword">yield</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/28/2020, 9:50:38 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/article/react.html" class="prev">
          react
        </a></span> <span class="next"><a href="/article/reactRouter.html">
          react-router
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.2d5a21ba.js" defer></script><script src="/assets/js/23.9be9c45e.js" defer></script>
  </body>
</html>
