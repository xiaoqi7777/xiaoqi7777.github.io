<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack(深) | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.eab45adb.css" as="style"><link rel="preload" href="/assets/js/app.2d5a21ba.js" as="script"><link rel="preload" href="/assets/js/9.c9c66d36.js" as="script"><link rel="prefetch" href="/assets/js/10.8a362e98.js"><link rel="prefetch" href="/assets/js/11.d74a0997.js"><link rel="prefetch" href="/assets/js/12.e2a162e2.js"><link rel="prefetch" href="/assets/js/13.84c6fa39.js"><link rel="prefetch" href="/assets/js/14.c4eac9aa.js"><link rel="prefetch" href="/assets/js/15.6e106e89.js"><link rel="prefetch" href="/assets/js/16.9e29e9f1.js"><link rel="prefetch" href="/assets/js/17.9b3a8933.js"><link rel="prefetch" href="/assets/js/18.f0190824.js"><link rel="prefetch" href="/assets/js/19.9e8ce3c8.js"><link rel="prefetch" href="/assets/js/2.39847600.js"><link rel="prefetch" href="/assets/js/20.f1e6b579.js"><link rel="prefetch" href="/assets/js/21.f06a428f.js"><link rel="prefetch" href="/assets/js/22.e8fff36c.js"><link rel="prefetch" href="/assets/js/23.9be9c45e.js"><link rel="prefetch" href="/assets/js/24.b1a2e86a.js"><link rel="prefetch" href="/assets/js/25.2721ff74.js"><link rel="prefetch" href="/assets/js/26.2cca1f22.js"><link rel="prefetch" href="/assets/js/27.60ac312a.js"><link rel="prefetch" href="/assets/js/28.a51bcc0b.js"><link rel="prefetch" href="/assets/js/29.d4d7922b.js"><link rel="prefetch" href="/assets/js/3.e8366ca8.js"><link rel="prefetch" href="/assets/js/30.284529e8.js"><link rel="prefetch" href="/assets/js/31.329482e5.js"><link rel="prefetch" href="/assets/js/32.1dd41dba.js"><link rel="prefetch" href="/assets/js/33.cdaf88aa.js"><link rel="prefetch" href="/assets/js/34.d2260297.js"><link rel="prefetch" href="/assets/js/35.0f100cdc.js"><link rel="prefetch" href="/assets/js/36.2d7b8183.js"><link rel="prefetch" href="/assets/js/37.58e42fab.js"><link rel="prefetch" href="/assets/js/38.b702c8f5.js"><link rel="prefetch" href="/assets/js/39.82cf90ef.js"><link rel="prefetch" href="/assets/js/4.f13a62f3.js"><link rel="prefetch" href="/assets/js/40.5e523f7a.js"><link rel="prefetch" href="/assets/js/41.bdd3935e.js"><link rel="prefetch" href="/assets/js/42.38f97d1a.js"><link rel="prefetch" href="/assets/js/43.fde099dd.js"><link rel="prefetch" href="/assets/js/44.1c37dd97.js"><link rel="prefetch" href="/assets/js/45.98b02b2e.js"><link rel="prefetch" href="/assets/js/46.42f3fcd7.js"><link rel="prefetch" href="/assets/js/47.e82a83b5.js"><link rel="prefetch" href="/assets/js/48.198aa16b.js"><link rel="prefetch" href="/assets/js/49.584f6640.js"><link rel="prefetch" href="/assets/js/5.1ee23f75.js"><link rel="prefetch" href="/assets/js/50.8b31f4da.js"><link rel="prefetch" href="/assets/js/51.78f5d0ad.js"><link rel="prefetch" href="/assets/js/52.31174a6a.js"><link rel="prefetch" href="/assets/js/53.077bd356.js"><link rel="prefetch" href="/assets/js/54.3de7f928.js"><link rel="prefetch" href="/assets/js/55.3ad4df39.js"><link rel="prefetch" href="/assets/js/56.785eabef.js"><link rel="prefetch" href="/assets/js/57.8b4691e9.js"><link rel="prefetch" href="/assets/js/58.f7997b54.js"><link rel="prefetch" href="/assets/js/59.d7a4d8a8.js"><link rel="prefetch" href="/assets/js/6.705f6278.js"><link rel="prefetch" href="/assets/js/60.ddb9f94c.js"><link rel="prefetch" href="/assets/js/61.26981a47.js"><link rel="prefetch" href="/assets/js/62.3f032d2a.js"><link rel="prefetch" href="/assets/js/63.39527714.js"><link rel="prefetch" href="/assets/js/64.8868dd89.js"><link rel="prefetch" href="/assets/js/65.6b974d81.js"><link rel="prefetch" href="/assets/js/66.855c5823.js"><link rel="prefetch" href="/assets/js/67.31e1762e.js"><link rel="prefetch" href="/assets/js/68.8c46b6ac.js"><link rel="prefetch" href="/assets/js/69.86ace7af.js"><link rel="prefetch" href="/assets/js/7.1fd1c381.js"><link rel="prefetch" href="/assets/js/70.351ae70a.js"><link rel="prefetch" href="/assets/js/71.1d26e844.js"><link rel="prefetch" href="/assets/js/72.1df64755.js"><link rel="prefetch" href="/assets/js/73.090c6271.js"><link rel="prefetch" href="/assets/js/74.5788c180.js"><link rel="prefetch" href="/assets/js/75.74f8c6f5.js"><link rel="prefetch" href="/assets/js/76.7e7562cd.js"><link rel="prefetch" href="/assets/js/77.777397ae.js"><link rel="prefetch" href="/assets/js/78.d7cc5ce5.js"><link rel="prefetch" href="/assets/js/79.d294b892.js"><link rel="prefetch" href="/assets/js/8.60fbcf9b.js"><link rel="prefetch" href="/assets/js/80.99fd18d4.js"><link rel="prefetch" href="/assets/js/81.2c0e2273.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eab45adb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>article</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/webpack.html" class="sidebar-link">webpack(基础)</a></li><li><a href="/article/module.html" class="sidebar-link">module</a></li><li><a href="/article/vueAnalysis.html" class="sidebar-link">vue</a></li><li><a href="/article/vueN.html" class="sidebar-link">vue</a></li><li><a href="/article/promise.html" class="sidebar-link">promise &amp;&amp; Event Loop</a></li><li><a href="/article/wx.html" class="sidebar-link">微信公众号</a></li><li><a href="/article/frontModle.html" class="sidebar-link">发布订阅模式&amp;&amp;观察者模式</a></li><li><a href="/article/vuePlugin.html" class="sidebar-link">vuePlugin</a></li><li><a href="/article/jwtPrinciple.html" class="sidebar-link">jwt</a></li><li><a href="/article/routerAuth.html" class="sidebar-link">routerAuth</a></li><li><a href="/article/statusCode.html" class="sidebar-link">常用的状态码</a></li><li><a href="/article/koa_express.html" class="sidebar-link">koa&amp;&amp;express</a></li><li><a href="/article/useLibrary.html" class="sidebar-link">常用库</a></li><li><a href="/article/reg.html" class="sidebar-link">正则</a></li><li><a href="/article/deepWebpack.html" class="active sidebar-link">webpack(深)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#模板解析" class="sidebar-link">模板解析</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#webpack-源码入口分析" class="sidebar-link">webpack 源码入口分析</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#webpack工作流程" class="sidebar-link">webpack工作流程</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#plugin-插件" class="sidebar-link">plugin 插件</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#loader-原理解析" class="sidebar-link">loader 原理解析</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#懒加载" class="sidebar-link">懒加载</a></li><li class="sidebar-sub-header"><a href="/article/deepWebpack.html#hmr" class="sidebar-link">hmr</a></li></ul></li><li><a href="/article/ts.html" class="sidebar-link">ts</a></li><li><a href="/article/wqianduan.html" class="sidebar-link">微前端</a></li><li><a href="/article/vue3.html" class="sidebar-link">vue3</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>react</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/react.html" class="sidebar-link">react</a></li><li><a href="/article/redux.html" class="sidebar-link">redux</a></li><li><a href="/article/reactRouter.html" class="sidebar-link">react-router</a></li><li><a href="/article/dva.html" class="sidebar-link">dva</a></li><li><a href="/article/hook.html" class="sidebar-link">hooks</a></li><li><a href="/article/reactSource.html" class="sidebar-link">react source</a></li><li><a href="/article/fiber.html" class="sidebar-link">fiber</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/vueSource.html" class="sidebar-link">vue source</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>axios</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/axios.html" class="sidebar-link">axios</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>upload</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/upload.html" class="sidebar-link">upload</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>binary</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/binary.html" class="sidebar-link">二进制</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>monitor</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/monitor.html" class="sidebar-link">监控</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="webpack-深"><a href="#webpack-深" aria-hidden="true" class="header-anchor">#</a> webpack(深)</h1> <p></p><div class="table-of-contents"><ul><li><a href="#模板解析">模板解析</a><ul><li><a href="#webpack-require">__webpack_require__</a></li><li><a href="#webpack-require-d">__webpack_require__.d</a></li><li><a href="#webpack-require-r">__webpack_require__.r</a></li><li><a href="#webpack-require-n">__webpack_require__.n</a></li><li><a href="#webpack-require-t">__webpack_require__.t</a></li><li><a href="#webpack-require-e">__webpack_require__.e</a></li></ul></li><li><a href="#webpack-源码入口分析">webpack 源码入口分析</a></li><li><a href="#webpack工作流程">webpack工作流程</a></li><li><a href="#plugin-插件">plugin 插件</a><ul><li><a href="#创建插件">创建插件</a></li><li><a href="#compiler">compiler</a></li><li><a href="#compilation">compilation</a></li><li><a href="#myplugin">MyPlugin</a></li><li><a href="#emitplugin">EmitPlugin</a></li><li><a href="#doneplugin">DonePlugin</a></li><li><a href="#optimizeplugin">OptimizePlugin</a></li><li><a href="#zipplugin">ZipPlugin</a></li></ul></li><li><a href="#loader-原理解析">loader 原理解析</a><ul><li><a href="#style-loader">style-loader</a></li><li><a href="#postcss">postcss</a></li><li><a href="#sprite-loader">sprite-loader</a></li><li><a href="#px2rem-loader">px2rem-loader</a></li><li><a href="#css-loader">css-loader</a></li><li><a href="#url-loader">url-loader</a></li><li><a href="#file-loader">file-loader</a></li><li><a href="#babel-loader">babel-loader</a></li><li><a href="#banner-loader">banner-loader</a></li><li><a href="#exact-loader">exact-loader</a></li></ul></li><li><a href="#懒加载">懒加载</a><ul><li><a href="#代码切割">代码切割</a></li><li><a href="#加载数据-具体参考-webpack-require-e-章节">加载数据(具体参考__webpack_require__.e章节)</a></li></ul></li><li><a href="#hmr">hmr</a><ul><li><a href="#server">server</a></li><li><a href="#client">client</a></li></ul></li></ul></div><p></p> <h2 id="模板解析"><a href="#模板解析" aria-hidden="true" class="header-anchor">#</a> 模板解析</h2> <ul><li>代码打包后的固有结构对他里面方法进行解析</li></ul> <h3 id="webpack-require"><a href="#webpack-require" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__</code></h3> <ul><li>模板内部自己实现了 commonjs 规范(也就是module.exports)</li> <li>打包文件就是一个自执行函数,参数是一个对象,对象是由文件的相对路径和文件内容构成 {key:value} 形式,主体实现了<code>commonjs</code></li> <li>打包编译的文件 内部将所有的 <code>require</code>语法 转换成了<code>__webpack_require__</code>。 首次都是执行入口文件<code>__webpack_require__('./src/index.js')</code>,里面地址根据项目的实际情况,<code>moduleId</code>是每个文件的相对路径,也作为模块的唯一ID。获取第一个<code>moduleId</code>的执行函数,第一个参数是自己定义的 <code>module</code>他是实现<code>commonjs</code>的核心,执行函数内的<code>module.exports</code>实际指向 自定义的<code>let module</code>里的<code>exports:{}</code>,当前的<code>__webpack_require__</code>执行完成后 又将<code>module.exports</code> 返回出去,这样下来 第一个<code>let rs = __webpack_require__('./src/title.js')</code> 就是获取到<code>./src/title.js</code>文件内的导出的值。执行函数的第三个参数是<code>__webpack_require__</code>,他是专门用来给导入模块,取代之前的<code>require</code>功能。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      i<span class="token punctuation">:</span>moduleId<span class="token punctuation">,</span>
      l<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
      exports<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>module<span class="token punctuation">,</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>__webpack_require__<span class="token punctuation">)</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>exports<span class="token punctuation">,</span>__webpack_require__</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
    let rs = __webpack_require__('./src/title.js')
    console.log(rs)
    `</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>exports<span class="token punctuation">,</span>__webpack_require__</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`module.exports = 'ssssss'`</span></span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-require-d"><a href="#webpack-require-d" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__.d</code></h3> <ul><li>d 是<code>defineProperty</code>的缩写 通过getter的方式增加属性</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token keyword">get</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="webpack-require-r"><a href="#webpack-require-r" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__.r</code></h3> <ul><li>r 方式是定义es6模块</li> <li><code>Object.prototype.toString.call()</code>判断是个数据的类型 会返回<code>[object type]</code>,其实他内部是找的<code>Symbol.toStringTag</code>属性,当两个都是对象的时候 就无法区别他们了,可以通过<code>Symbol.toStringTag</code>修改属性</li> <li>定义<code>__esModule</code>为<code>true</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span><span class="token punctuation">{</span>
    value<span class="token punctuation">:</span><span class="token string">'Module'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'__esModule'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">r</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-require-n"><a href="#webpack-require-n" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__.n</code></h3> <ul><li>让module 兼容es模块</li> <li>module 可能是一个commonjs模块,也可能是一个es6模块</li> <li>es6模块 会有一个 __esModule = true,默认导出在模块的default属性上</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">n</span><span class="token punctuation">(</span><span class="token parameter">mod</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter <span class="token operator">=</span> mod<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> mod<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> mod
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> getter
<span class="token punctuation">}</span>
<span class="token keyword">let</span> mod <span class="token operator">=</span> <span class="token punctuation">{</span>
  __esModule <span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'xx'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> mod2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span><span class="token string">'123123'</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> getter <span class="token operator">=</span><span class="token function">n</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-require-t"><a href="#webpack-require-t" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__.t</code></h3> <ul><li>处理返回值(代码分割用)</li> <li>根据 mode 参数进行 &amp; 计算, 0001 &amp; 1 即为true, 0001即加载模块, 0010 用es6批量导出数据, 0100 如果是es6模块 直接返回值, 1000 不需要处理直接返回</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>mode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//这个模块ID需要加载</span>
    value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果已经是es6模块 直接返回</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span><span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 8 直接返回 不需要包装</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ns<span class="token punctuation">.</span>__esModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  ns<span class="token punctuation">.</span>default <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token comment">// 把value放在新创建的命名空间的default属性上</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果2为true,就把value的所有属性都拷贝到ns对象上</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span><span class="token punctuation">{</span>
      ns<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ns
<span class="token punctuation">}</span>
<span class="token comment">// 用法</span>
<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 声明了一个新的模块</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">:</span>moduleId<span class="token punctuation">,</span>
    l<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>module<span class="token punctuation">,</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>__webpack_require__<span class="token punctuation">)</span>
  module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;moduleA&quot;</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>exports</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'moduleA导出内容'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;moduleB&quot;</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>exports</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      __esModule<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span><span class="token string">'moduleB导出内容'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;moduleC&quot;</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>exports</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'moduleC导出的内容'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> moduleA <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'moduleA'</span><span class="token punctuation">,</span><span class="token number">0b1001</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleA<span class="token punctuation">)</span>
<span class="token keyword">let</span> moduleB <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'moduleB'</span><span class="token punctuation">,</span><span class="token number">0b0101</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleB<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
<span class="token comment">// 强行的把 moduleC 安装es6module 返回</span>
<span class="token keyword">let</span> moduleC <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'moduleC'</span><span class="token punctuation">,</span><span class="token number">0b0111</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0111转成十进制7 </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleC<span class="token punctuation">)</span>
</code></pre></div><h3 id="webpack-require-e"><a href="#webpack-require-e" aria-hidden="true" class="header-anchor">#</a> <code>__webpack_require__.e</code></h3> <ul><li>懒加载 <code>__webpack_require__.e</code> 利用了jsonp 加载数据</li> <li>异步加载流程
<ul><li>通过click加载,<code>__webpack_require__.e('src_title_js')</code>此函数主要处理了2件事 第一个是缓存加载的状态<code>installedChunks[chunkId] = [resolve,reject]</code>,第二个是 通过jsonp创建<code>script</code>标签请求<code>src_title_js.js</code>文件的数据,返回的数据会触发<code>window[&quot;webpackJsonp&quot;]</code>从而将对象传递给<code>webpackJsonpCallback</code>函数。</li> <li><code>webpackJsonpCallback</code>作为jsonp的回调,主要做了3件事。第一是获取缓存状态<code>installedChunks[chunkId]</code>的<code>resolve</code>放到resolves数组中,第二件是循环 <code>moreModules</code>的数据,<code>modules[moduleId] = moreModules[moduleId]</code> 将他注入到主体的<code>modules</code>中,这样等待<code>__webpack_require__</code>加载数据,第三件循环执行<code>resolves</code>里面的状态,当所有状态执行完成,就会进入<code>__webpack_require__.e(&quot;src_title_js&quot;)</code>的then回调。</li> <li><code>__webpack_require__.t</code>参数<code>moduleId</code>是用来请求数据,mode 值是7(0111)。除了(mode&amp;8) 其他都会进去,
<ul><li>(mode &amp; 1) 会通过<code>__webpack_require__</code> 获取数据,之前在<code>modules</code>注入的数据这儿用的</li> <li>(mode &amp; 4)(mode &amp; 2) 处理数据 返回一个对象,一个es6模块的对象</li></ul></li> <li>最终返回一个es6模块 通过default 获取值</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// jsonp 创建script 加载数据</span>
__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 先从缓存里取得当前代码块加载的状态</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>installedChunkData <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 表示未加载,需要立即加载</span>
    <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">;</span>
    promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> chunkId <span class="token operator">+</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>

<span class="token comment">// 异步加载的数据  src_title_js.js</span>
  <span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;src_title_js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>

   <span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">:</span>
  
   <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;module.exports = '11111111111123'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// jsonp 的回调</span>
  <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunkIds <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//['title']</span>
    <span class="token keyword">let</span> moreModules <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> chunkId<span class="token punctuation">;</span>
    <span class="token keyword">let</span> resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">{</span>
      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">var</span> jsonArray <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  jsonArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback<span class="token punctuation">;</span>

<span class="token comment">// 异步加载模块</span>
 button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;src_title_js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">,</span> <span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="webpack-源码入口分析"><a href="#webpack-源码入口分析" aria-hidden="true" class="header-anchor">#</a> webpack 源码入口分析</h2> <ul><li>所有的 指令他不会去node_modules/.bin 下去查找</li> <li>npx webpack 执行的时候 他会找node_modules/bin/webpack.cmd</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  %~dp0 是指当前的目录</span>
<span class="token comment">// 他会去找 _webpack@4.41.2@webpack\bin\webpack.js</span>
@<span class="token constant">SETLOCAL</span>

@<span class="token constant">IF</span> <span class="token constant">EXIST</span> <span class="token string">&quot;%~dp0\node.exe&quot;</span> <span class="token punctuation">(</span>
  @<span class="token constant">SET</span> <span class="token string">&quot;_prog=%~dp0\node.exe&quot;</span>
<span class="token punctuation">)</span> <span class="token constant">ELSE</span> <span class="token punctuation">(</span>
  @<span class="token constant">SET</span> <span class="token string">&quot;_prog=node&quot;</span>
  @<span class="token constant">SET</span> <span class="token constant">PATHEXT</span><span class="token operator">=</span><span class="token operator">%</span><span class="token constant">PATHEXT</span><span class="token punctuation">:</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token constant">JS</span><span class="token punctuation">;</span><span class="token operator">=</span><span class="token punctuation">;</span><span class="token operator">%</span>
<span class="token punctuation">)</span>

<span class="token string">&quot;%_prog%&quot;</span>  <span class="token string">&quot;%~dp0\..\_webpack@4.41.2@webpack\bin\webpack.js&quot;</span> <span class="token operator">%</span><span class="token operator">*</span>
@<span class="token constant">ENDLOCAL</span>
</code></pre></div><ul><li>webpack/bin/cli 是打包的入口</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 此文件可以单独 运行 他会执行打包</span>
<span class="token comment">// 执行打包的核心 ..\_webpack@4.41.2@webpack\bin\webpack.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pkgPath <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`webpack-cli/package.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line node/no-missing-require</span>
<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// eslint-disable-next-line node/no-missing-require</span>
<span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//webpack-cli</span>
  <span class="token comment">// pkg.bin['webpack-cli']</span>
  <span class="token string">&quot;./bin/cli.js&quot;</span><span class="token comment">// webpack-cli/./bin/cli.js 这个是一切打包的入口 打断点就在这儿</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  他会执行 webpack-cli/bin/cli.js 文件</span>
</code></pre></div><ul><li>webpack-cli/bin/cli.js 获取配置文件执行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>	<span class="token keyword">let</span> compiler<span class="token punctuation">;</span>
	compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">err2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">compilerCallback</span><span class="token punctuation">(</span>err <span class="token operator">||</span> err2<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">compilerCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="webpack工作流程"><a href="#webpack工作流程" aria-hidden="true" class="header-anchor">#</a> webpack工作流程</h2> <ul><li><p>$$=&gt;表示发射事件</p></li> <li><p>1、配置</p> <ul><li>解析shell和webpack的配置项</li> <li>激活webpack插件的加载</li></ul></li> <li><p>2、webpack初始化 入口文件(<code>index.js/webpack-cli/bin/webpack.js compiler = new Webpack(options)</code>)</p> <ul><li>1、创建 <code>Compiler</code> 对象,在启动<code>webpack</code>时候被一次性建立,所有的插件都是基于 Compiler 的hooks</li> <li>2、注册 <code>NodeEnvironmentPlugin</code> 插件,往 <code>Compiler</code>上挂载<code>node</code>相关的理模块(fs等)</li> <li>3、获取<code>options</code>中的<code>plugin</code>(外部插件),挂载插件,等待后面各个环节触发插件钩子</li> <li>4、使用 <code>WebpackOptionsApply</code> 初始化基础插件
<ul><li>$$ <code>Compiler:entryOption</code> 在 webpack 中的 entry 配置处理过之后</li></ul></li> <li>名字区别 <code>compiler</code> 全局只有一个,最初开始实例化的 理解为 编写者  <code>compilation</code> 代码 解析打包的时候 才实例化 可以理解编写</li></ul></li> <li><p>3、run 开始编译(<code>Compiler.js/webpack-cli/bin/webpack.js compiler.run(compilerCallback)</code>)</p> <ul><li>1、run函数里面 调用 <code>this.compile</code>开启编译</li> <li>2、<code>compile</code>编译的时候 实例化一个<code>Compilation</code> 他负责整个编译过程
<ul><li>1、内部<code>this.compiler</code> 保存了<code>compiler</code>对象的引用</li> <li>2、创建<code>this.entries=[]</code> 入口列表</li> <li>3、创建<code>this.chunks=[]</code> 代码块</li> <li>4、创建<code>this.modules=[]</code> 所有模块</li> <li>5、创建<code>this.assets=[]</code> 所有资源</li> <li>6、template
<ul><li>this.mainTemplate 编译主体模板</li> <li>this.chunkTemplate</li> <li>this.hotUpdateChunkTemplate</li> <li>this.runtimeTemplate</li> <li>this.moduleTemplates</li></ul></li> <li>$$ <code>Compiler:beforeRun</code>  开始正式编译之前</li> <li>$$ <code>Compiler:beforeCompile</code> compilation 实例化需要的参数创建完毕之后</li> <li>$$ <code>Compiler:compile</code> 一次 compilation 编译创建之前</li> <li>$$ <code>Compiler:thisCompilation</code> 触发 compilation 事件之前执行</li> <li>$$ <code>Compiler:compilation</code> compilation创建成功之后</li></ul></li></ul></li> <li><p>4、make 制作</p> <ul><li>1、执行make钩子 触发<code>SingleEntryPlugin</code>的插件 执行<code>compilation.addEntry(添加入口)</code></li> <li>2、<code>_addModuleChain(增加模块链)</code>,根据入口文件通过对应的工厂方法创建模块,保存到<code>Compilation.entries</code>中</li> <li>3、对<code>module</code>进行<code>build</code>(Compilation),递归处理依赖的模块 =&gt; 对源码的解析处理(以下都是在NormalModule.js处理)
<ul><li>1、<code>getSource</code> 调用loader处理源码</li> <li>2、使用<code>acorn</code>生成AST 遍历AST,将所有的<code>require</code>全部替换成<code>__webpack_require__</code>。</li> <li>3、如果源码里遇到<code>require</code>依赖,创建<code>dependencies</code>加入依赖数组,只要遇到<code>require</code>就会一直加入到依赖项,<code>Dependency</code>加入的数据结构与<code>NormalModule</code>类 接收的参数一致</li> <li>4、module处理完成后 在处理依赖模块(就是<code>buildDependencies(Compilation里)</code>接收两参数,第二个参数是依赖项),若里面有数据 就会一致递归</li></ul></li> <li>$$ <code>Compilation:buildModule</code> 在模块构建开始之前触发</li> <li>$$ <code>Compilation:successModule</code> 模块构建成功时执行</li> <li>$$ <code>Compilation:finishModules</code> 所有模块都完成构建</li></ul></li> <li><p>5、seal 封包</p> <ul><li>1、调用<code>compilation.seal</code> 对每个module和chunk进行整理,生成编译后的代码,合并,拆分。<code>chunks</code>里面存放着 同一个入口文件 所有require的资源
<ul><li>1、<code>this.entries</code>存放所有的入口列表()</li> <li>2、<code>this._modules</code>存放的模块代码(每一个路径对应着,require 解析后的code)</li> <li>3、<code>this.modules</code>存放所有的模块(所有require的都会push进去)</li> <li>4、<code>this.chunks</code>存放的代码块 将获取的<code>module</code>用<code>Chunk</code>进行了封装</li> <li>5、<code>this.files</code>存放的所有入口的路径</li> <li>6、<code>this.assets</code>存放每个入口的打包资源文件</li></ul></li> <li>2、<code>this.createChunkAssets</code>建立代码块资源,通过模板把chunk生成__webpack_require__()的格式 , mainTemplate处理入口的module ,chunkTemplate处理异步加载,生成资源放在compilation.assets中</li> <li>$$ <code>Compilation:seal</code>         编译（compilation）停止接收新模块时触发</li> <li>$$ <code>Compilation:optimize</code>       优化阶段开始时触发</li> <li>$$ <code>Compilation:optimizeTree</code>     异步优化依赖树</li> <li>$$ <code>Compilation:afterOptimizeTree</code>  异步优化依赖树完成时</li> <li>$$ <code>Compilation:optimizeChunkModulesBasic</code>  基础优化单个chunk中的 modules 开始</li> <li>$$ <code>Compilation:reviveModules</code>    从 records 中恢复模块信息</li> <li>$$ <code>Compilation:reviveChunks</code>   从 records 中恢复 chunk 信息</li> <li>$$ <code>Compilation:beforeChunks</code>   开始生成代码块</li> <li>$$ <code>Compilation:beforeHash</code>       在编译被哈希（hashed）之前</li> <li>$$ <code>Compilation:afterHash</code>        在编译被哈希（hashed）之后</li> <li>$$ <code>Compilation:afterChunks</code>    生成代码块之后</li> <li>$$ <code>Compilation:beforeModuleAssets</code>  在创建模块的资源之前</li> <li>$$ <code>Compilation:chunkAsset</code>  一个 chunk 中的一个资源被添加到编译中</li></ul></li> <li><p>6、最后执行回调函数,把Assets输出到output的path中,<code>Compiler.emitAssets</code>是回调的写入文件的方法</p> <ul><li>$$ <code>Compiler:emit</code>  生成资源到 output 目录之前</li> <li>$$ <code>Compiler:afterEmit</code> 生成资源到 output 目录之后</li> <li>$$ <code>Compiler:done</code> compilation完成之后</li> <li>$$ <code>Compiler:afterSeal</code>  seal之后</li></ul></li> <li><p>Compilation 核心的数据</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//入口列表 指的是 entry 入口文件的列表</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 模块代码  {'代码路径':'编译后的代码'}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 所有模块 每一次require 编译this 存放进去</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 代码块 存放着入口文件 对应的所有资源</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
  <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token comment">//资源 </span>
</code></pre></div><ul><li>流程图
<img src="/img/webpackcode.jpg"></li></ul> <h2 id="plugin-插件"><a href="#plugin-插件" aria-hidden="true" class="header-anchor">#</a> plugin 插件</h2> <ul><li>webpack内部通过<code>tapable</code>申明的</li> <li>第一步 创建一个钩子实例<code>environment : new SyncHook(['name'])</code> 有参数就往数组内添加(发布订阅)</li> <li>第二步 往实例上 挂载(订阅)钩子<code>environment.tap('MyPlugin',()=&gt;{})</code></li> <li>第三部 在各个环节 触发(发布)钩子<code>environment.call('123123')</code></li></ul> <h3 id="创建插件"><a href="#创建插件" aria-hidden="true" class="header-anchor">#</a> 创建插件</h3> <ul><li>组成
<ul><li>插件函数的prototype 上定义一个apply方法</li> <li>执行一个绑定webpack自身事件的钩子</li> <li>处理webpack内部实例的特定数据</li> <li>功能完成后调用webpack提供回调</li></ul></li></ul> <h3 id="compiler"><a href="#compiler" aria-hidden="true" class="header-anchor">#</a> compiler</h3> <ul><li>代表了完整的webpack环境配置,这个对象在启动webpack时被一次性建立,并配置好所有可操作性的设置,包括options,loader和plugin.在webpack环境中应用一个插件时,插件将受到此compiler对象的引用.可以是用它来访问webpack的主环境</li></ul> <h3 id="compilation"><a href="#compilation" aria-hidden="true" class="header-anchor">#</a> compilation</h3> <ul><li>代表一次资源版本构建,当运行webpack开发环境中间件时,每当检测到一个文件变化,就会创建一个新的compilation,从而生成一组新的编译资源,一个compilation队表现了当前的模块资源,编译生成资源,变化文件,以及被跟踪依赖的状态信息,compilation对象也提供了很多关键的时机的回调</li></ul> <h3 id="myplugin"><a href="#myplugin" aria-hidden="true" class="header-anchor">#</a> MyPlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPlugin</span><span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">complier</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    complier<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'MyPlugin--&gt;'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPlugin<span class="token punctuation">;</span>
</code></pre></div><h3 id="emitplugin"><a href="#emitplugin" aria-hidden="true" class="header-anchor">#</a> EmitPlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 我们想知道如果获取到 compilation 对象</span>
<span class="token keyword">class</span> <span class="token class-name">EmitPlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">complier</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// AsyncSeriesHook 异步的串行钩子    </span>
    complier<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'EmitPlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 获取到 compilation 对象</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// 里面必须返回 2函数 这是格式</span>
        compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'xxx.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token string">'xxxxx'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token string">'xxxxx'</span><span class="token punctuation">.</span>length<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EmitPlugin
</code></pre></div><h3 id="doneplugin"><a href="#doneplugin" aria-hidden="true" class="header-anchor">#</a> DonePlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 插件就是一个类  有一个apply方法 接收一个compiler对象</span>
<span class="token comment">// 我们会在compiler对象的钩子上挂载一些监听函数,当compiler这个对象上这些钩子触发的时候 会执行对应的监听函数</span>
<span class="token keyword">class</span> <span class="token class-name">DonePlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token comment">// 内部会调用 apply 方法</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 每次编译完成后,都会call done这个事件</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DonePlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>message<span class="token operator">||</span><span class="token string">'编译完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin
</code></pre></div><h3 id="optimizeplugin"><a href="#optimizeplugin" aria-hidden="true" class="header-anchor">#</a> OptimizePlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 我们想知道如果获取到 compilation 对象</span>
<span class="token keyword">class</span> <span class="token class-name">OptimizePlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">complier</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取到 compilation 对象 每当compiler对象创建出来一个compilation编译对象 那么就会触发回调 参数是compilation</span>
    complier<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'OptimizePlugin'</span><span class="token punctuation">,</span><span class="token parameter">compilation</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'OptimizePlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack 编译对象正则优化中。。。。。。'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> OptimizePlugin
</code></pre></div><h3 id="zipplugin"><a href="#zipplugin" aria-hidden="true" class="header-anchor">#</a> ZipPlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> JSZip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jszip'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>RawSource<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-sources'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ZipPlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">complier</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 当资源已经准备就绪 准备向输出的目录里写入的时候 会触发这个钩子</span>
    <span class="token comment">// tapAsync/tapPromise 都可以</span>
    <span class="token comment">// complier.hooks.emit.tapAsync('ZipPlugin',(compilation,callback)=&gt;{</span>
    <span class="token comment">//   // 获取到 compilation 对象</span>
    <span class="token comment">//   // compilation.assets 代表有哪些资源要打包  source 是打包的内容</span>
    <span class="token comment">//   // console.log(compilation.assets) </span>
    <span class="token comment">//   var zip = new  JSZip();</span>
    <span class="token comment">//   for(let filename in compilation.assets){</span>
    <span class="token comment">//     zip.file(filename,compilation.assets[filename].source())</span>
    <span class="token comment">//   }</span>
    <span class="token comment">//   // 把所有的文件压成一个压缩包 得到压缩包的二进制内容</span>
    <span class="token comment">//   zip.generateAsync({type:'nodebuffer'}).then(content=&gt;{</span>
    <span class="token comment">//     // 向assets 上挂载了一个新的属性和值</span>
    <span class="token comment">//     // compilation.assets[this.options.name] = {</span>
    <span class="token comment">//     //   source(){return content},</span>
    <span class="token comment">//     //   size(){return content.length}</span>
    <span class="token comment">//     // };</span>
          <span class="token comment">// 两种写法  RawSource 就是一个class 进行了封装 实际和上面是一样</span>
    <span class="token comment">//     compilation.assets[this.options.name] = new RawSource(content);</span>
    <span class="token comment">//     callback(null,compilation);</span>
    <span class="token comment">//   })</span>
    <span class="token comment">// })</span>
    <span class="token comment">// tapPromise</span>
    complier<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'ZipPlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 获取到 compilation 对象</span>
      <span class="token comment">// compilation.assets 代表有哪些资源要打包  source 是打包的内容</span>
      <span class="token comment">// console.log(compilation.assets) </span>
      <span class="token keyword">var</span> zip <span class="token operator">=</span> <span class="token keyword">new</span>  <span class="token class-name">JSZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> filename <span class="token keyword">in</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">{</span>
        zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>  zip<span class="token punctuation">.</span><span class="token function">generateAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'nodebuffer'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// 往文件内写东西 不用直接写  将要写的内容挂载到 compilation.assets里面 内部会自动写入</span>
        compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> content<span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> content<span class="token punctuation">.</span>length<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">RawSource</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content
  <span class="token punctuation">}</span>
  <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> content<span class="token punctuation">}</span>
  <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> content<span class="token punctuation">.</span>length<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ZipPlugin
<span class="token comment">/**
  写插件的一般思路
  1、找到插件代码 需要执行的钩子
  2、知道钩子函数的参数和数据结构,进行加工
 * 
 */</span>
</code></pre></div><h2 id="loader-原理解析"><a href="#loader-原理解析" aria-hidden="true" class="header-anchor">#</a> loader 原理解析</h2> <ul><li>loader 原理
<ul><li>每一个loader都是一个函数,loader包含 pitch 和 normal,当配置<code>use:['style-loader','css-loader']</code> 我们常说从右往左执行,实际这个指的是 normal loader,loader的执行顺序是: <code>style-loader.pitch =&gt; css-loader.pitch =&gt; css-loader.normal(普通) =&gt; style-loader.normal</code>。平常很少用到pitch但实际情况是他先执行，如果他返回一个不为<code>undefined</code> 那么会结束后面的要执行的loader,直接进入上一个loader的pitch方法中。</li> <li>下面附带 webpack内部 resource和loader 之间的关系,当路径匹配上后(<code>content = loader(content)</code>) resource会将自己传入loader内进行处理,后面返回resource,注意传递进去的是 string(可执行的js) 传出来的也是 string
<ul><li>下面第二个js 是loader内部解析,先分析 resource 的处理 整体情况后面再分析</li> <li>pitch 核心处理 <code>pitchFn.apply(loaderContext,[loaderContext.remindingRequest,loaderContext.previousRequest,loaderContext.data])</code></li> <li>normal 核心处理 <code>normalFn.apply(loaderContext,[args])</code></li> <li>上面2个处理 最终都会进入到<code>if(loaderContext.loaderIndex&lt;0){ return finallyCallback(null,args) }</code>,将他们执行后的结果返回出去 这样就将webpack 内部的 resource 进行的处理</li></ul></li> <li>整个loader处理和webpack就关联起来了</li></ul></li> <li>解刨 normal 和 pitch
<ul><li>调用 runLoaders 函数 接收配置参数 和 回调函数,注意<code>context</code>是loader内的上下文 可以传递数据<code>pitch</code>的第三个参数和this.data 同一个对象(都是上下文),在<code>pitch</code>内给第三个参数设置 在其他loader和 normal 都是可以通过<code>this.data</code>获取到的</li> <li>runLoaders 函数 主要处理了3件事</li> <li>1、将参数全部保存到<code>loaderContext</code>(也是指向context)对象上</li> <li>2、<code>defineProperty(loaderContext)</code> 给上下文 增加属性 <code>request</code>(所有请求的loader) <code>remindingRequest</code>(剩下的loader) <code>previousRequest</code>(之前请求的loader) <code>currentRequest</code>(当前的loader)<code>data</code>(当前的上下文)</li> <li>3、<code>loaderContext.async</code>处理异步问题 他async 挂载到上下文</li> <li>4、执行<code>iteratePitchingLoaders</code> pitch</li> <li>剩下的就是 <code>iteratePitchingLoaders</code>和<code>iterateNormalLoaders</code>之间的一点逻辑判断</li> <li>pitch loader 函数处理 <code>let args = pitchFn.apply(loaderContext,[loaderContext.remindingRequest,loaderContext.previousRequest,loaderContext.data])</code>这个是处理pitch loader 接收的参数 第一个是 剩下的loader(也就是当前loader之后的loader) 第二个是 之前的loader 第三个是 当前的上下文 最后返回的还是一个 字符串 (可执行的js)</li> <li>normal loader 函数处理 <code>normalFn.apply(loaderContext,[args])</code> 他接收的就是上一个传递过来的 resource 是一个字符串 (可执行的js),同样他返回也是这样的 字符串</li></ul></li> <li>pitch 作用:让两个loader配合使用(在css-loader和style-loader体现明显)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// loader1</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> inputSource <span class="token operator">+</span><span class="token string">'//loader1'</span>
<span class="token punctuation">}</span>

loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  data<span class="token punctuation">.</span>pitch1 <span class="token operator">=</span> <span class="token string">'pitch1'</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader

<span class="token comment">// loader2</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>inputSource<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pitch2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader

<span class="token comment">// loader3</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader3'</span><span class="token punctuation">,</span>inputSource<span class="token punctuation">)</span>
  <span class="token keyword">return</span> inputSource
<span class="token punctuation">}</span>

loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pitch3'</span><span class="token punctuation">)</span>
  
<span class="token punctuation">}</span>
<span class="token comment">// 默认情况下loader得到的内容是字符串 如果想要的得到二进制文件 需要把raw=true</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader

<span class="token comment">// loader  pitch/normal</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createLoaderObject</span><span class="token punctuation">(</span><span class="token parameter">loaderPath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//data是用来在pitch和normal里面传递数据的</span>
  obj<span class="token punctuation">.</span>request <span class="token operator">=</span> loaderPath<span class="token punctuation">;</span><span class="token comment">//loader这个文件绝对值</span>
  obj<span class="token punctuation">.</span>normal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//正常的loader函数</span>
  obj<span class="token punctuation">.</span>pitch <span class="token operator">=</span> obj<span class="token punctuation">.</span>normal<span class="token punctuation">.</span>pitch<span class="token punctuation">;</span><span class="token comment">//pitch函数</span>
  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">loaderContext</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 当index为1的时候</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// request loader1!loader2!loader3!hello.js</span>
      <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span><span class="token operator">=&gt;</span>loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token string">'remindingRequest'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// request loader3!hello.js</span>
      <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span><span class="token operator">=&gt;</span>loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token string">'previousRequest'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// request loader1</span>
      <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token string">'currentRequest'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// request loader2!loader3!hello.js</span>
      <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span><span class="token operator">=&gt;</span>loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span>args<span class="token punctuation">,</span>finallyCallback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token function">finallyCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentLoaderObject <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> normalFn <span class="token operator">=</span> currentLoaderObject<span class="token punctuation">.</span>normal
    args <span class="token operator">=</span> <span class="token function">normalFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token punctuation">[</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isSync<span class="token punctuation">)</span><span class="token punctuation">{</span>
      loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span>
      <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>args<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">processResource</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span>finallyCallback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 默认读出来的是buffer</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span><span class="token function">readResource</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>normal<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">{</span>
    result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>result<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span>finallyCallback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">&gt;=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">processResource</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> currentLoaderObject <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pitchFn <span class="token operator">=</span> currentLoaderObject<span class="token punctuation">.</span>pitch
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pitchFn<span class="token punctuation">)</span><span class="token punctuation">{</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 剩下的 request 前面的 request </span>
  <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token function">pitchFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span><span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>remindingRequest<span class="token punctuation">,</span>loaderContext<span class="token punctuation">.</span>previousRequest<span class="token punctuation">,</span>loaderContext<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>args<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> isSync <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token keyword">function</span> <span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span>finallyCallback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> loaderContext <span class="token operator">=</span> options<span class="token punctuation">.</span>context<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// loader的上下文环境</span>
  loaderContext<span class="token punctuation">.</span>resource <span class="token operator">=</span> options<span class="token punctuation">.</span>resource<span class="token punctuation">;</span><span class="token comment">// 要加载的资源 hello.js</span>
  loaderContext<span class="token punctuation">.</span>loaders <span class="token operator">=</span> options<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createLoaderObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// loaderIndex是正在执行loader的索引</span>
  loaderContext<span class="token punctuation">.</span>readResource <span class="token operator">=</span> options<span class="token punctuation">.</span>readResource<span class="token punctuation">;</span><span class="token comment">// fs.readFile</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">)</span>
  
  <span class="token keyword">function</span> <span class="token function">asyncCallback</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    isSync <span class="token operator">=</span> <span class="token boolean">true</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>result<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  loaderContext<span class="token punctuation">.</span><span class="token function-variable function">async</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    isSync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> asyncCallback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span>finallyCallback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  resource<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src'</span><span class="token punctuation">,</span><span class="token string">'hello.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//要加载的资源</span>
  loaders<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token comment">// 我们要用这三个loader去转换hello.js</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loader'</span><span class="token punctuation">,</span><span class="token string">'loader1.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loader'</span><span class="token punctuation">,</span><span class="token string">'loader2.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loader'</span><span class="token punctuation">,</span><span class="token string">'loader3.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  context<span class="token punctuation">:</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  readResource<span class="token punctuation">:</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>rs</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'=&gt;'</span><span class="token punctuation">,</span>rs<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="style-loader"><a href="#style-loader" aria-hidden="true" class="header-anchor">#</a> style-loader</h3> <ul><li>style-loader 主要作用将css 代码插入到页面的style标签中</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
<span class="token comment">// 不配合 css-loader 时候用</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> style<span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    let style = document.createElement('style')
    style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    document.head.appendChild(style)
    `</span></span>
    style <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(\\+n|\+r)/g</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> style
<span class="token punctuation">}</span>
<span class="token comment">// pitch 作用是 让两个loader配合使用</span>
      
<span class="token comment">// ** 最后 require是在浏览器执行的</span>

<span class="token comment">// 如果不加 !! 会出现死循环</span>

<span class="token comment">// 处理 css 的时候  会先执行 style pitch 如果用loader处理(他无法处理js) 在pitch处理的时候他能通过`remindingRequest`获取剩下的loader 这里要在loader加!! 表示 只能当前的loader(或者叫内联loader处理) 如果不他 他还会走到`style-loader`内 会造成无线循环</span>
<span class="token comment">// 配合 css-loader 时候用</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remainingRequest</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> script <span class="token operator">=</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
      let style = document.createElement('style')
      style.innerHTML = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">&quot;!!&quot;</span><span class="token operator">+</span>remainingRequest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
      document.head.appendChild(style)
    `</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> script
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="postcss"><a href="#postcss" aria-hidden="true" class="header-anchor">#</a> postcss</h3> <ul><li><a href="https://astexplorer.net/#/2uBU1BLuJ1" target="_blank" rel="noopener noreferrer">ast<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://api.postcss.org/" target="_blank" rel="noopener noreferrer">api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>postcss 是用来解析css 转换成ast(类似)  主要功能是插件做的
<ul><li>他和babel一样只有分解功能 没有变化功能,具体操作需要插件</li> <li>用法(下面是固定格式,具体例子看下面 css-loader)</li></ul></li> <li>基础用法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 插件</span>
 <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 遍历每一条规则</span>
     <span class="token comment">// css.walkDecls </span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">logo</span><span class="token punctuation">(</span><span class="token string">'rs'</span><span class="token punctuation">,</span> rs<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="sprite-loader"><a href="#sprite-loader" aria-hidden="true" class="header-anchor">#</a> sprite-loader</h3> <ul><li>spritesmith 用法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> SpriteSmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> sprites <span class="token operator">=</span> <span class="token punctuation">[</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../img/1.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../img/2.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../img/3.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
SpriteSmith<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>src<span class="token punctuation">:</span>sprites<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'sprite.jpg'</span><span class="token punctuation">,</span>result<span class="token punctuation">.</span>image<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> SpriteSmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//this.context 代表被加载资源的上下文目录</span>
  <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'url'</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token comment">// 拼一个路径 找到的是这个图片的绝对路径</span>
              <span class="token keyword">let</span> url <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>context<span class="token punctuation">,</span>item<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
              item<span class="token punctuation">.</span>url <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">;</span>
              <span class="token comment">// 案例说我要在当前规则下面添加一条background-position</span>
              postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                url<span class="token punctuation">,</span><span class="token comment">// 原始图片的绝对路径,未来合并雪碧图用</span>
                rule<span class="token punctuation">:</span>decl<span class="token punctuation">.</span>parent <span class="token comment">// </span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// css 添加数据 先给他们一个占位符 在替换 </span>
      postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>rule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// 注意这个的 index 用法 首次数组为空  加一个数组内容对应的index 就会变化</span>
        rule<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
          postcss<span class="token punctuation">.</span><span class="token function">decl</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            prop<span class="token punctuation">:</span><span class="token string">'background-position'</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span><span class="token template-string"><span class="token string">`_BACKGROUND_POSITION_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span>spriteFilename<span class="token punctuation">:</span><span class="token string">'sprite.jpg'</span><span class="token punctuation">,</span>rules<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> cssStr <span class="token operator">=</span> rs<span class="token punctuation">.</span>css
    <span class="token keyword">let</span> sprites <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    SpriteSmith<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>src<span class="token punctuation">:</span>sprites<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> coordinates <span class="token operator">=</span> result<span class="token punctuation">.</span>coordinates
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        cssStr <span class="token operator">=</span> cssStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_BACKGROUND_POSITION_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px -</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      that<span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">,</span>result<span class="token punctuation">.</span>image<span class="token punctuation">)</span>
      <span class="token comment">// 注意 导出的是模块是字符串 要加'' JSON.stringify功能就是加''但是他比直接加'' 要好,他可以出来\n  </span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="px2rem-loader"><a href="#px2rem-loader" aria-hidden="true" class="header-anchor">#</a> px2rem-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> SpriteSmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>remUnit<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">,</span>remPrecision<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">}</span> <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//this.context 代表被加载资源的上下文目录</span>
  <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">let</span> px <span class="token operator">=</span>  <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>px<span class="token operator">/</span>remUnit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>remPrecision<span class="token punctuation">)</span><span class="token punctuation">;</span>
              item<span class="token punctuation">.</span>name <span class="token operator">=</span> rem<span class="token operator">+</span><span class="token string">'rem'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> cssStr <span class="token operator">=</span> rs<span class="token punctuation">.</span>css
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="css-loader"><a href="#css-loader" aria-hidden="true" class="header-anchor">#</a> css-loader</h3> <ul><li>作用是处理css中的 @import 和 url 这样的外部资源</li> <li>安装<code>postcss</code> 将css 转换成ast语法树</li> <li>css-loader的原理 解析css 语法 找到 url 个 @import 将他们替换成 <code>require</code> 语法,将处理的数据 返回给 style-loader 处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-selector-tokenizer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>urlItems<span class="token punctuation">,</span>importItems<span class="token punctuation">}</span> <span class="token operator">=</span> options
    <span class="token comment">// 遍历 import等规则</span>
    css<span class="token punctuation">.</span><span class="token function">walkAtRules</span><span class="token punctuation">(</span><span class="token regex">/^import$/</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> values<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">//{value:'./base.css'}</span>
      importItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历每一条规则</span>
    css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 将字符串转成对象</span>
      <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token comment">// '75px solid red'</span>
      values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>url
            item<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`_CSS_URL_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlItems<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_`</span></span>
            urlItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token comment">// .avatar.gif</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 将对象转成字符串</span>
      decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    importItems<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    urlItems<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// loaderUtils.stringifyRequest他 可以把一个绝对路径 转换成合适loader的相对路径</span>
  <span class="token comment">// background-img:url(./avatar.gif)</span>
  <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> importJs <span class="token operator">=</span> options<span class="token punctuation">.</span>importItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">imp</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// return '&quot;+require(&quot;'+imp+'&quot;)+&quot;'</span>
      <span class="token keyword">return</span> <span class="token string">&quot;require(&quot;</span><span class="token operator">+</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>imp<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;)&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token comment">// @import './base.css';</span>
    <span class="token keyword">let</span> cssString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token comment">// url('_CSS_URL_0_')</span>
  
    <span class="token comment">// 替换 @import './base.css'</span>
    cssString <span class="token operator">=</span> cssString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@import\s+?.+?;/</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 替换 url('_CSS_URL_0_')</span>
    cssString <span class="token operator">=</span> cssString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_CSS_URL_(\d+?)_/g</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> imageUrl <span class="token operator">=</span> options<span class="token punctuation">.</span>urlItems<span class="token punctuation">[</span><span class="token operator">+</span>group1<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//  打包的时候 imageUrl 变成真实的地址  最后 require是在浏览器执行的</span>
      <span class="token keyword">return</span> <span class="token string">'&quot;+require(&quot;'</span><span class="token operator">+</span>imageUrl<span class="token operator">+</span><span class="token string">'&quot;)+&quot;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ${importJs}</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token template-string"><span class="token string">`
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importJs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
    `</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="url-loader"><a href="#url-loader" aria-hidden="true" class="header-anchor">#</a> url-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
  读取源文件的内容,并且重命名 写入到新的输出目录下
  如果文件的大小小于limit的话,就不在拷贝新的文件到输出目录,而是直接返回base64字符串
*/</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getOptions<span class="token punctuation">,</span>interpolateName<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fileLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// this = loaderContext</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>filename<span class="token operator">=</span><span class="token string">'[name].[hash].[ext]'</span><span class="token punctuation">,</span>limit<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span>content<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token operator">&lt;</span>limit<span class="token punctuation">)</span><span class="token punctuation">{</span>
  
    <span class="token comment">// base64 格式 data:image/jpeg;base64,xxxxxxxxx</span>
    <span class="token keyword">const</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回次图片的内容类型</span>
    <span class="token keyword">let</span> base64 <span class="token operator">=</span> <span class="token template-string"><span class="token string">`data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contentType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// JSON.stringify 作用是在外面包裹一层 字符串 module.exports = ${JSON.stringify(base64)} 这个是要在浏览器跑的  </span>
    <span class="token comment">// 浏览器 自己模拟了一套commonjs规范 module.exports 所以 module.exports 能在浏览器执行</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">fileLoader</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="file-loader"><a href="#file-loader" aria-hidden="true" class="header-anchor">#</a> file-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
  读取源文件的内容,并且重命名 写入到新的输出目录下
*/</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getOptions<span class="token punctuation">,</span>interpolateName<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// [name].[hash].[ext]这些占位符 都在 loader-utils 里面文档有写</span>
  <span class="token keyword">let</span> filename <span class="token operator">=</span> options<span class="token punctuation">.</span>filename<span class="token operator">||</span><span class="token string">'[name].[hash].[ext]'</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 生成文件名字 第一个是this 第二个是一个字符串 第三个是content 内容</span>
  <span class="token keyword">let</span> outputFilename <span class="token operator">=</span>  <span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>filename<span class="token punctuation">,</span><span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 写文件 把content内容输出到outputFilename 里</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>outputFilename<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
  <span class="token comment">/*
    1、使用 require('xxx') 
    2、使用 url('xxxx') 
    
    首先遇到 url 的时候 css 会处理他 将他url 转换成require 的格式
    图片都是require 进去的 所以file-loader 需要给他们导出一个 url 的地址  也就是上面emitFile 发射出去的名字
  */</span>  
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>outputFilename<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="babel-loader"><a href="#babel-loader" aria-hidden="true" class="header-anchor">#</a> babel-loader</h3> <ul><li>babel 插件写法(提交例子可以参考 箭头函数的转换=&gt;搜索 ArrowFunctionExpression)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> transformArrayFunction <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// visitor 可以访问源代码生成的语法树的所有节点,捕获特定的节点</span>
  visitor<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 节点</span>
    <span class="token function-variable function">Identifier</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span><span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>transformArrayFunction<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>rs</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>babel.transform</code> 将源代码 转义成ast,他的作用只是ast 其他的处理全部交给插件处理,同时加入配置 这里的options和webpack loader里面的配置是一模一样的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token comment">// </span>
  <span class="token keyword">let</span>  options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
   options <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>options<span class="token punctuation">,</span><span class="token comment">//二选一</span>
    <span class="token comment">// presets:[  &quot;@babel/preset-env&quot;],</span>
    sourceMaps<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 告诉babel我要生成sourcemap 如果提供了 webpack sourcemap就用它的 不给它自己弄 , 要设置 devtool:'source-map' 自己设置后names 选项就有值了</span>
    filename<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token comment">// 内部的api this上提供的 当前处理文件的路径，例如 /src/main.js</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//  转义之后会生成3个文件</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">)</span>
  <span class="token comment">// 我们可以吧sourcemap ast 都传给webpack 这样webpack就不需要自己吧源代码转语法树了，也不需要自己生成sourcemap</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre></div><h3 id="banner-loader"><a href="#banner-loader" aria-hidden="true" class="header-anchor">#</a> banner-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//把loader改为异步,任务完成后需要手工执行callback</span>
    <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启用loader缓存</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cacheable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用来验证options的合法性</span>
    <span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> 
        type<span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
        properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            filename<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> <span class="token string">'string'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            text<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> <span class="token string">'string'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//通过工具方法获取options</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用来验证options的合法性</span>
    <span class="token function">validateOptions</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'Banner-Loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> text<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> text <span class="token operator">+</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> text <span class="token operator">+</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="exact-loader"><a href="#exact-loader" aria-hidden="true" class="header-anchor">#</a> exact-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//把CSS文件单独放置到一个文件中去，然后在页面中通过link标签去引入</span>
<span class="token keyword">let</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//发射或者说输出一个文件，这个文件的内容 就是css文件的内容</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token string">'main.css'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    let link  = document.createElement('link');
    link.setAttribute('rel','stylesheet');
    link.setAttribute('href','main.css');
    document.head.appendChild(link);
  `</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> script<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h2 id="懒加载"><a href="#懒加载" aria-hidden="true" class="header-anchor">#</a> 懒加载</h2> <h3 id="代码切割"><a href="#代码切割" aria-hidden="true" class="header-anchor">#</a> 代码切割</h3> <ul><li>babel ast 解析中 replaceWithSourceString 可以用来替换原有的数据</li> <li>发生在make阶段,之前讲了在ast 语法解析的时候 将所有的<code>require</code> 替换成了<code>__webpack_require__</code>,webpack 内部实现了一套commonjs 所有不需要<code>require</code>。</li> <li>懒加载用的是<code>import()</code>用法 在 ast 解析的时候,会识别这个语法 将<code>import(xx)</code>替换成<code>__webpack_require__.e(&quot;${dependencyChunkId}&quot;).then(__webpack_require__.t.bind(__webpack_require__,&quot;${dependencyModuleId}&quot;,7))</code>结构,<code>dependencyChunkId</code>是打包后加载异步代码文件的名字,<code>dependencyModuleId</code>是打包前加载异步代码的路径</li> <li>在整个节点替换后 调用<code>compilation._addModuleChain</code>将异步代码<code>dependencyModuleId, dependencyChunkId</code>传入进去</li> <li><code>_addModuleChain</code>方法主要是将入口模块编译打包,添加到<code>this.entries</code>里。异步加载的文件是一个单独的文件,可以简单理解成一个入口模块</li> <li>在<code>seal</code>封包的时候 会根据<code>this.entries</code>循环入口模块 创建 Chunk对象,此处就是代码分隔,将分隔好的chunk存入<code>this.chunks</code>中。</li> <li>执行<code>createChunkAssets</code>函数 根据<code>this.entries</code>创建代码块资源 若<code>chunk</code>是main 是入口文件 就用主模板编译渲染,否则用异步模板渲染。</li> <li>最后将打包好的资源存放到<code>this.assets</code>(是一个对象,key是文件名字,value是要写入的资源),等待<code>emitAssets</code>发射资源的时候 读取<code>compilation</code>中的<code>assets</code>,将文件写入本地。</li> <li>打包前后的代码对比</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 异步代码打包前</span>
<span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'异步加载额外的模块'</span>
button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 魔法注释</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName:'index1' */</span><span class="token string">'./title.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>

<span class="token comment">// 异步代码打包后</span>
<span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'异步加载额外的模块'</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 魔法注释</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;src_title_js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">,</span> <span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="加载数据-具体参考-webpack-require-e章节"><a href="#加载数据-具体参考-webpack-require-e章节" aria-hidden="true" class="header-anchor">#</a> 加载数据(具体参考<code>__webpack_require__.e</code>章节)</h3> <ul><li>懒加载,前面将数据切割好,后面加载数据主要利用了jsonp</li> <li>异步加载流程
<ul><li>通过click加载,<code>__webpack_require__.e('src_title_js')</code>此函数主要处理了2件事 第一个是缓存加载的状态<code>installedChunks[chunkId] = [resolve,reject]</code>,第二个是 通过jsonp创建<code>script</code>标签请求<code>src_title_js.js</code>文件的数据,返回的数据会触发<code>window[&quot;webpackJsonp&quot;]</code>从而将对象传递给<code>webpackJsonpCallback</code>函数。</li> <li><code>webpackJsonpCallback</code>作为jsonp的回调,主要做了3件事。第一是获取缓存状态<code>installedChunks[chunkId]</code>的<code>resolve</code>放到resolves数组中,第二件是循环 <code>moreModules</code>的数据,<code>modules[moduleId] = moreModules[moduleId]</code> 将他注入到主体的<code>modules</code>中,这样等待<code>__webpack_require__</code>加载数据,第三件循环执行<code>resolves</code>里面的状态,当所有状态执行完成,就会进入<code>__webpack_require__.e(&quot;src_title_js&quot;)</code>的then回调。</li> <li><code>__webpack_require__.t</code>参数<code>moduleId</code>是用来请求数据,mode 值是7(0111)。除了(mode&amp;8) 其他都会进去,
<ul><li>(mode &amp; 1) 会通过<code>__webpack_require__</code> 获取数据,之前在<code>modules</code>注入的数据这儿用的</li> <li>(mode &amp; 4)(mode &amp; 2) 处理数据 返回一个对象,一个es6模块的对象</li></ul></li> <li>最终返回一个es6模块 通过default 获取值</li></ul></li></ul> <h2 id="hmr"><a href="#hmr" aria-hidden="true" class="header-anchor">#</a> hmr</h2> <h3 id="server"><a href="#server" aria-hidden="true" class="header-anchor">#</a> server</h3> <ul><li>1、创建一个server 实例</li> <li>2、创建 通过<code>express</code>&amp;&amp;<code>socket.io</code>(源码里用的websocket)创建服务</li> <li>3、当<code>connection</code>连接上时, 说明有浏览器访问,此时将socket存放起来,首次一般都是请求index.html和main.js等初始化文件,只要请求成功，都会给客户端发送<code>hash</code>&amp;&amp;<code>ok</code>事件</li> <li>4、<code>memory-fs</code>是操作内存的读写,之前源码里面介绍<code>compiler.outputFileSystem = fs</code>fs模块赋值给<code>compiler.outputFileSystem</code>,fs对硬盘的操作。在这里将<code>memory-fs</code>赋值给<code>compiler.outputFileSystem</code>,因为<code>dev-server</code>所有的操作全是在内存中。</li> <li>5、中间件处理前端的请求，通过请求的url配合<code>config.output.path</code>得到真实的数据路径,读取路径数据发给前端</li> <li>6、<code>compiler.hooks.done</code>在webpack编译完成后触发的,回调参数能获取hash值 也就是每次编译产生的hash值。循环处理<code>sockets</code>(他代表浏览器客户端socket),回调函数的参数能获取到当前的编译的hash值,同时利用socket给客户端发送<code>hash</code>(传递hash值)&amp;&amp;<code>ok</code>事件</li></ul> <h3 id="client"><a href="#client" aria-hidden="true" class="header-anchor">#</a> client</h3> <ul><li>webpack.HotModuleReplacementPlugin 这个插件就是创建了一个client</li> <li>html文件引入<code>&lt;script src=&quot;socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</code></li> <li>1、初始化socket</li> <li>2、监控<code>hash</code>&amp;&amp;<code>ok</code>事件,接收hash值保存起来,后面很有用</li> <li>3、实例化一个发布订阅类的实例,处理hot逻辑,订阅<code>webpackHotUpdate</code>事件,当hash第一个传递过来的时候,保存起来,直接return,当后面的hash传递进来的时候 执行<code>hotCheck</code>函数</li> <li>4、触发ok事件,说明启动hot模式,执行reloadApp,发射<code>webpackHotUpdate</code>事件,第一个是保存hash,我们直接考虑第二次的情况,执行hotCheck函数</li> <li>5、<code>hotDownloadManifest</code>下载描述文件用ajax,主要处理服务器到这一次编译相对于上一次编译改变了哪些chunk?哪些模块。通过 <code>hotCurrentHash+'.hot-update.json'</code>地址 发送ajax请求获取数据<code>{h:'hash',c:{chunkId:true,chunkId1:true}}</code>,h是本次编译的hash值,c是变化的chunkId,可能是0个或者多个。<code>hotCurrentHash+'.hot-update.json'</code>文件里面存放着从上一次编译到这一次编译,这里的<code>hotCurrentHash</code>指的是上一次的hash 不是这一次的。</li> <li>6、<code>hotDownloadUpdateChunk</code>加载新资源文件用jsonp,下面是他返回的结构,所以要定义<code>window['webpackHotUpdate']</code>方法接收,源码里有这个<code>__webpack_require__.c=installedModules</code>是一个模块缓存,从<code>__webpack_require__.c[moduleId]</code>获取到<code>parents</code>后面用来更新,<code>__webpack_require__.c[moduleId] 对象里的parents,children,hot</code>只有在热更新的时候才会用,<code>moreModules[moduleId].call</code>更新代码，接着需要触发<code>accept</code>接收的回调函数,之前保存在当前module的hot中,当前可以通过parent获取到执行<code>parentModule.hot._acceptedDependencies[moduleId]()</code></li> <li>7、最后数据更新完成后 需要将最新的hash赋值到<code>hotCurrentHash</code>内</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
webpackHotUpdate(&quot;index&quot;,{

&quot;./src/title.js&quot;:
 (function(module, exports) {

  eval(&quot;console.log('xxxxxx')\r\nmodule.exports = '121111aaaa11111111111111'\r\n\r\n// http://localhost:8000/37953468a7ad03e521c6.hot-update.json\r\n// http://localhost:8000/a496d9e16160c7981cc0.hot-update.json\r\n// http://localhost:8000/cfff9a21f7800d159a11.hot-update.json\n\n//# sourceURL=webpack:///./src/title.js?&quot;);

  })
})
*/</span> 
</code></pre></div><p>遍历chunkIds(有数据的情况下)通过jsonp的方式去请求变化的chunk,<code>chunkId+hotCurrentHash(当前编译前的hash)+.hot-update.js</code>获取jsonp数据</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/28/2020, 9:50:38 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/article/reg.html" class="prev">
          正则
        </a></span> <span class="next"><a href="/article/ts.html">
          ts
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.2d5a21ba.js" defer></script><script src="/assets/js/9.c9c66d36.js" defer></script>
  </body>
</html>
