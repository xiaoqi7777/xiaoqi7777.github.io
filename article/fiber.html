<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>fiber | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.eab45adb.css" as="style"><link rel="preload" href="/assets/js/app.2d5a21ba.js" as="script"><link rel="preload" href="/assets/js/12.e2a162e2.js" as="script"><link rel="prefetch" href="/assets/js/10.8a362e98.js"><link rel="prefetch" href="/assets/js/11.d74a0997.js"><link rel="prefetch" href="/assets/js/13.84c6fa39.js"><link rel="prefetch" href="/assets/js/14.c4eac9aa.js"><link rel="prefetch" href="/assets/js/15.6e106e89.js"><link rel="prefetch" href="/assets/js/16.9e29e9f1.js"><link rel="prefetch" href="/assets/js/17.9b3a8933.js"><link rel="prefetch" href="/assets/js/18.f0190824.js"><link rel="prefetch" href="/assets/js/19.9e8ce3c8.js"><link rel="prefetch" href="/assets/js/2.39847600.js"><link rel="prefetch" href="/assets/js/20.f1e6b579.js"><link rel="prefetch" href="/assets/js/21.f06a428f.js"><link rel="prefetch" href="/assets/js/22.e8fff36c.js"><link rel="prefetch" href="/assets/js/23.9be9c45e.js"><link rel="prefetch" href="/assets/js/24.b1a2e86a.js"><link rel="prefetch" href="/assets/js/25.2721ff74.js"><link rel="prefetch" href="/assets/js/26.2cca1f22.js"><link rel="prefetch" href="/assets/js/27.60ac312a.js"><link rel="prefetch" href="/assets/js/28.a51bcc0b.js"><link rel="prefetch" href="/assets/js/29.d4d7922b.js"><link rel="prefetch" href="/assets/js/3.e8366ca8.js"><link rel="prefetch" href="/assets/js/30.284529e8.js"><link rel="prefetch" href="/assets/js/31.329482e5.js"><link rel="prefetch" href="/assets/js/32.1dd41dba.js"><link rel="prefetch" href="/assets/js/33.cdaf88aa.js"><link rel="prefetch" href="/assets/js/34.d2260297.js"><link rel="prefetch" href="/assets/js/35.0f100cdc.js"><link rel="prefetch" href="/assets/js/36.2d7b8183.js"><link rel="prefetch" href="/assets/js/37.58e42fab.js"><link rel="prefetch" href="/assets/js/38.b702c8f5.js"><link rel="prefetch" href="/assets/js/39.82cf90ef.js"><link rel="prefetch" href="/assets/js/4.f13a62f3.js"><link rel="prefetch" href="/assets/js/40.5e523f7a.js"><link rel="prefetch" href="/assets/js/41.bdd3935e.js"><link rel="prefetch" href="/assets/js/42.38f97d1a.js"><link rel="prefetch" href="/assets/js/43.fde099dd.js"><link rel="prefetch" href="/assets/js/44.1c37dd97.js"><link rel="prefetch" href="/assets/js/45.98b02b2e.js"><link rel="prefetch" href="/assets/js/46.42f3fcd7.js"><link rel="prefetch" href="/assets/js/47.e82a83b5.js"><link rel="prefetch" href="/assets/js/48.198aa16b.js"><link rel="prefetch" href="/assets/js/49.584f6640.js"><link rel="prefetch" href="/assets/js/5.1ee23f75.js"><link rel="prefetch" href="/assets/js/50.8b31f4da.js"><link rel="prefetch" href="/assets/js/51.78f5d0ad.js"><link rel="prefetch" href="/assets/js/52.31174a6a.js"><link rel="prefetch" href="/assets/js/53.077bd356.js"><link rel="prefetch" href="/assets/js/54.3de7f928.js"><link rel="prefetch" href="/assets/js/55.3ad4df39.js"><link rel="prefetch" href="/assets/js/56.785eabef.js"><link rel="prefetch" href="/assets/js/57.8b4691e9.js"><link rel="prefetch" href="/assets/js/58.f7997b54.js"><link rel="prefetch" href="/assets/js/59.d7a4d8a8.js"><link rel="prefetch" href="/assets/js/6.705f6278.js"><link rel="prefetch" href="/assets/js/60.ddb9f94c.js"><link rel="prefetch" href="/assets/js/61.26981a47.js"><link rel="prefetch" href="/assets/js/62.3f032d2a.js"><link rel="prefetch" href="/assets/js/63.39527714.js"><link rel="prefetch" href="/assets/js/64.8868dd89.js"><link rel="prefetch" href="/assets/js/65.6b974d81.js"><link rel="prefetch" href="/assets/js/66.855c5823.js"><link rel="prefetch" href="/assets/js/67.31e1762e.js"><link rel="prefetch" href="/assets/js/68.8c46b6ac.js"><link rel="prefetch" href="/assets/js/69.86ace7af.js"><link rel="prefetch" href="/assets/js/7.1fd1c381.js"><link rel="prefetch" href="/assets/js/70.351ae70a.js"><link rel="prefetch" href="/assets/js/71.1d26e844.js"><link rel="prefetch" href="/assets/js/72.1df64755.js"><link rel="prefetch" href="/assets/js/73.090c6271.js"><link rel="prefetch" href="/assets/js/74.5788c180.js"><link rel="prefetch" href="/assets/js/75.74f8c6f5.js"><link rel="prefetch" href="/assets/js/76.7e7562cd.js"><link rel="prefetch" href="/assets/js/77.777397ae.js"><link rel="prefetch" href="/assets/js/78.d7cc5ce5.js"><link rel="prefetch" href="/assets/js/79.d294b892.js"><link rel="prefetch" href="/assets/js/8.60fbcf9b.js"><link rel="prefetch" href="/assets/js/80.99fd18d4.js"><link rel="prefetch" href="/assets/js/81.2c0e2273.js"><link rel="prefetch" href="/assets/js/9.c9c66d36.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eab45adb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>article</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/webpack.html" class="sidebar-link">webpack(基础)</a></li><li><a href="/article/module.html" class="sidebar-link">module</a></li><li><a href="/article/vueAnalysis.html" class="sidebar-link">vue</a></li><li><a href="/article/vueN.html" class="sidebar-link">vue</a></li><li><a href="/article/promise.html" class="sidebar-link">promise &amp;&amp; Event Loop</a></li><li><a href="/article/wx.html" class="sidebar-link">微信公众号</a></li><li><a href="/article/frontModle.html" class="sidebar-link">发布订阅模式&amp;&amp;观察者模式</a></li><li><a href="/article/vuePlugin.html" class="sidebar-link">vuePlugin</a></li><li><a href="/article/jwtPrinciple.html" class="sidebar-link">jwt</a></li><li><a href="/article/routerAuth.html" class="sidebar-link">routerAuth</a></li><li><a href="/article/statusCode.html" class="sidebar-link">常用的状态码</a></li><li><a href="/article/koa_express.html" class="sidebar-link">koa&amp;&amp;express</a></li><li><a href="/article/useLibrary.html" class="sidebar-link">常用库</a></li><li><a href="/article/reg.html" class="sidebar-link">正则</a></li><li><a href="/article/deepWebpack.html" class="sidebar-link">webpack(深)</a></li><li><a href="/article/ts.html" class="sidebar-link">ts</a></li><li><a href="/article/wqianduan.html" class="sidebar-link">微前端</a></li><li><a href="/article/vue3.html" class="sidebar-link">vue3</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>react</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/react.html" class="sidebar-link">react</a></li><li><a href="/article/redux.html" class="sidebar-link">redux</a></li><li><a href="/article/reactRouter.html" class="sidebar-link">react-router</a></li><li><a href="/article/dva.html" class="sidebar-link">dva</a></li><li><a href="/article/hook.html" class="sidebar-link">hooks</a></li><li><a href="/article/reactSource.html" class="sidebar-link">react source</a></li><li><a href="/article/fiber.html" class="active sidebar-link">fiber</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/fiber.html#基础知识" class="sidebar-link">基础知识</a></li><li class="sidebar-sub-header"><a href="/article/fiber.html#fiber1" class="sidebar-link">fiber1</a></li><li class="sidebar-sub-header"><a href="/article/fiber.html#fiber执行阶段" class="sidebar-link">Fiber执行阶段</a></li><li class="sidebar-sub-header"><a href="/article/fiber.html#初次渲染" class="sidebar-link">初次渲染</a></li><li class="sidebar-sub-header"><a href="/article/fiber.html#更新" class="sidebar-link">更新</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/vueSource.html" class="sidebar-link">vue source</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>axios</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/axios.html" class="sidebar-link">axios</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>upload</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/upload.html" class="sidebar-link">upload</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>binary</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/binary.html" class="sidebar-link">二进制</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>monitor</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/article/monitor.html" class="sidebar-link">监控</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="fiber"><a href="#fiber" aria-hidden="true" class="header-anchor">#</a> fiber</h1> <p><a href="https://github.com/xiaoqi7777/react.git" target="_blank" rel="noopener noreferrer">mock react<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> fiber分支</p> <p></p><div class="table-of-contents"><ul><li><a href="#基础知识">基础知识</a><ul><li><a href="#屏幕刷新率">屏幕刷新率</a></li><li><a href="#帧">帧</a></li><li><a href="#raf-requestanimationframe">rAf(requestAnimationFrame)</a></li><li><a href="#requestidlecallback">requestIdleCallback</a></li><li><a href="#单链表">单链表</a></li></ul></li><li><a href="#fiber1">fiber1</a><ul><li><a href="#fiber-之前的reconcilation-协调">Fiber 之前的Reconcilation(协调)</a></li><li><a href="#fiber">Fiber</a></li><li><a href="#模拟fiber-执行过程-后面会详细分析">模拟fiber 执行过程 后面会详细分析</a></li></ul></li><li><a href="#fiber执行阶段">Fiber执行阶段</a></li><li><a href="#初次渲染">初次渲染</a><ul><li><a href="#_1、scheduleroot">1、scheduleRoot</a></li><li><a href="#_2、schedule-调度整体流程">2、schedule(调度整体流程)</a></li><li><a href="#渲染-按照上面的element进行初次渲染-来看下利用这三条规则进行渲染">渲染 按照上面的element进行初次渲染,来看下利用这三条规则进行渲染</a></li></ul></li><li><a href="#更新">更新</a><ul><li><a href="#双缓存机制">双缓存机制</a></li></ul></li></ul></div><p></p> <h2 id="基础知识"><a href="#基础知识" aria-hidden="true" class="header-anchor">#</a> 基础知识</h2> <h3 id="屏幕刷新率"><a href="#屏幕刷新率" aria-hidden="true" class="header-anchor">#</a> 屏幕刷新率</h3> <ul><li>大多数设备的屏幕都是 60次/秒,页面是一帧绘制出来,当每秒绘制的帧数(FPS)到达60时,页面是流程的,小于这个值,用户会感觉到卡段</li> <li>每个帧的预算事件是16.66毫秒(1秒/60)，1s 60帧,所以每一帧分到的事件是 1000/60 = 16ms,所以我们的代码力求不让义诊的工作量超过16ms</li></ul> <h3 id="帧"><a href="#帧" aria-hidden="true" class="header-anchor">#</a> 帧</h3> <ul><li>每个帧的开头包括样式计算,布局和绘制</li> <li>js执行的js引擎和页面渲染引擎在同一个渲染现成,GUI渲染和js执行是互斥</li> <li>如果某个任务执行时间过长 浏览器会推迟渲染</li> <li>图片若显示过小 在新网页中看</li></ul> <img src="/img/lifeofframe.jpg"> <h3 id="raf-requestanimationframe"><a href="#raf-requestanimationframe" aria-hidden="true" class="header-anchor">#</a> rAf(requestAnimationFrame)</h3> <ul><li>requestAnimationFrame回调函数会在绘制之前执行,上图中显示他执行的时候在layout前面</li> <li>下面的用法  当浏览器绘制前操作dom 让他的width 一直增加</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>开始<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> start<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> div<span class="token punctuation">.</span>offsetWidth <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token string">'px'</span>
      div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> div<span class="token punctuation">.</span>offsetWidth <span class="token operator">+</span> <span class="token string">'%'</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>offsetWidth <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> current <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        start <span class="token operator">=</span> current
        timer <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="requestidlecallback"><a href="#requestidlecallback" aria-hidden="true" class="header-anchor">#</a> requestIdleCallback</h3> <ul><li>requestIdleCallback 作用是 当正常帧任务完成后没超过16秒,说明时间有富余,此时就会执行<code>requestIdleCallback</code>里注册的响应</li> <li><code>requestIdleCallback(callback,{timeout:1000})</code>,callback接收2个参数(didTimeout,timeRemaining())
<ul><li>didTimeout，布尔值，表示任务是否超时，结合 timeRemaining 使用</li> <li>timeRemaining(), 表示当前帧剩余的时间</li> <li>timeout表示如果超过这个时间后,任务还没有执行,则强制执行,不必等待
<img src="/img/cooperativescheduling.jpg"></li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// </span>
    <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&lt;=</span> d<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> works <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一个任务开始'</span><span class="token punctuation">)</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一个任务结束'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二个任务开始'</span><span class="token punctuation">)</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二个任务结束'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三个任务开始'</span><span class="token punctuation">)</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三个任务结束'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    <span class="token comment">// timeout 意思是 告诉浏览器 1000ms 即使你没有空闲时间也得帮我执行, 因为我等不及了</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">,</span><span class="token punctuation">{</span>timeout<span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadLine</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 返回值 deadLine.didTimeout 布尔值 表示任务是否超时 </span>
      <span class="token comment">// deadLine.timeRemaining() 表示当前帧剩余的时间</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'本帧剩余时间'</span><span class="token punctuation">,</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>deadLine<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>deadLine<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> deadLine<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> works<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>works<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`只剩下</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">parseInt</span><span class="token punctuation">(</span>deadLine<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms,时间片到了等待下次空闲时间的调度`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      works<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="单链表"><a href="#单链表" aria-hidden="true" class="header-anchor">#</a> 单链表</h3> <ul><li>单链表是一种链式存取的数据结构</li> <li>链表中的数据是以节点来表示的,每个节点的构成：元素+指针(指示后继元素的存储位子),元素就是存储数据的存储单元,指针就是连接每个节点的地址</li></ul> <img src="/img/singlelink2.jpg"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Update</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token punctuation">,</span>nextUpdate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>payload <span class="token operator">=</span> payload
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextUpdate <span class="token operator">=</span> nextUpdate
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseState <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate<span class="token punctuation">.</span>nextUpdate <span class="token operator">=</span> update
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseState <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">let</span> currentUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate
      <span class="token keyword">while</span><span class="token punctuation">(</span>currentUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">typeof</span> currentUpdate<span class="token punctuation">.</span>payload <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> currentUpdate<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span>currentState<span class="token punctuation">)</span> <span class="token punctuation">:</span> currentUpdate<span class="token punctuation">.</span>payload
        currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>currentState<span class="token punctuation">,</span><span class="token operator">...</span>nextState<span class="token punctuation">}</span>
        currentUpdate <span class="token operator">=</span> currentUpdate<span class="token punctuation">.</span>nextUpdate
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>baseState <span class="token operator">=</span> currentState
      <span class="token keyword">return</span> currentState
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'sg'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
queue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
queue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span>data<span class="token punctuation">.</span>age<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
queue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span>data<span class="token punctuation">.</span>age<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>baseState<span class="token punctuation">)</span>
</code></pre></div><h2 id="fiber1"><a href="#fiber1" aria-hidden="true" class="header-anchor">#</a> fiber1</h2> <h3 id="fiber-之前的reconcilation-协调"><a href="#fiber-之前的reconcilation-协调" aria-hidden="true" class="header-anchor">#</a> Fiber 之前的Reconcilation(协调)</h3> <ul><li>React 会递归对比VirtualDOM树,找出需要变动的节点,然后同步更新他们,这个过程叫<code>Reconcilation</code></li> <li>在协调期间,React 会一直占用着浏览器的资源，一则会导致用户触发的事件得不到响应，二会导致卡顿</li></ul> <h3 id="fiber-2"><a href="#fiber-2" aria-hidden="true" class="header-anchor">#</a> Fiber</h3> <ul><li>我们可以通过某些调度策略合理分配CPU资源,从而提高用户的响应数据</li> <li>通过Fiber,让自己的 <code>Reconcilation</code> 过程变成可被中断。适时让出CPU执行权,可以让浏览器及时地响应用户的交互</li> <li>Fiber也是一个执行单元,每次执行完一个执行单元,React就会检查现在还剩多少时间,如果没有时间就将控制权让出去</li></ul> <img src="/img/fiberflow.jpg"> <ul><li>Fiber同时也是一种数据结构
<ul><li>React目前使用的是链表,每个VirtualDOM 节点内部表示一个Fiber</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//类型  </span>
  type<span class="token punctuation">:</span> any<span class="token punctuation">,</span>
  <span class="token comment">//父节点</span>
  <span class="token keyword">return</span><span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// 指向第一个子节点</span>
  child<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// 指向下一个弟弟</span>
  sibling<span class="token punctuation">:</span> Fiber
<span class="token punctuation">}</span>
</code></pre></div><img src="/img/fiberconstructor.jpg"> <h3 id="模拟fiber-执行过程-后面会详细分析"><a href="#模拟fiber-执行过程-后面会详细分析" aria-hidden="true" class="header-anchor">#</a> 模拟fiber 执行过程 后面会详细分析</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
  1、从顶点开始遍历
  2、如果有儿子,先遍历大儿子
*/</span>
<span class="token comment">// 在浏览器执行</span>
<span class="token keyword">let</span> <span class="token constant">A1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'A1'</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token constant">B1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'B1'</span><span class="token punctuation">,</span><span class="token keyword">return</span><span class="token punctuation">:</span><span class="token constant">A1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">B2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'B2'</span><span class="token punctuation">,</span><span class="token keyword">return</span><span class="token punctuation">:</span><span class="token constant">A1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">C1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'C1'</span><span class="token punctuation">,</span><span class="token keyword">return</span><span class="token punctuation">:</span><span class="token constant">B1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">C2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>key<span class="token punctuation">:</span><span class="token string">'C2'</span><span class="token punctuation">,</span><span class="token keyword">return</span><span class="token punctuation">:</span><span class="token constant">B1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">A1</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token constant">B1</span><span class="token punctuation">;</span>
<span class="token constant">B1</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token constant">B2</span><span class="token punctuation">;</span>
<span class="token constant">B1</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token constant">C1</span><span class="token punctuation">;</span>
<span class="token constant">C1</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token constant">C2</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&lt;=</span> d<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// 下一个执行单元</span>
<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadLine</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>deadLine<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> deadLine<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render阶段执行结束'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">,</span><span class="token punctuation">{</span>timeout<span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 开始遍历</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">beginWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token comment">//处理fiber</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果有儿子 返回大儿子</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果没有儿子 说明此fiber已经完成了</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>sibling<span class="token comment">//如果有弟弟就返回 亲弟弟</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在找父亲的弟弟</span>
    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">,</span>fiber<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始'</span><span class="token punctuation">,</span>fiber<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
nextUnitOfWork <span class="token operator">=</span> <span class="token constant">A1</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">,</span><span class="token punctuation">{</span>timeout<span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="fiber执行阶段"><a href="#fiber执行阶段" aria-hidden="true" class="header-anchor">#</a> Fiber执行阶段</h2> <ul><li>每次渲染有两个阶段:Reconciliation(协调/渲染)和Commit(提交阶段)</li> <li>协调阶段:可以认为是Diff阶段,这个阶段可以被中断,这个阶段会找出所有节点变更,例如节点新增、删除、属性变更等等,这都称为react的(Effect)</li> <li>提交阶段:将上一个阶段计算出来的需要处理的副作用一次行执行了,这个解读那必须是同步执行,不能被打断</li></ul> <h2 id="初次渲染"><a href="#初次渲染" aria-hidden="true" class="header-anchor">#</a> 初次渲染</h2> <h3 id="_1、scheduleroot"><a href="#_1、scheduleroot" aria-hidden="true" class="header-anchor">#</a> 1、scheduleRoot</h3> <ul><li>以下所有的内容都是根据这个模板</li> <li>element通过babel编译成jsx语法,传给render方法,render会将element包装成一个fiber结构,进行调度根节点(scheduleRoot)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{</span> border<span class="token punctuation">:</span><span class="token string">'3px solid red'</span><span class="token punctuation">,</span>margin<span class="token punctuation">:</span><span class="token string">'5px'</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'A1'</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token constant">A1</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'B1'</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token constant">B1</span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'C1'</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token constant">C1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'C2'</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token constant">C2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'B2'</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  element<span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="_2、schedule-调度整体流程"><a href="#_2、schedule-调度整体流程" aria-hidden="true" class="header-anchor">#</a> 2、schedule(调度整体流程)</h3> <ul><li>根据下面3条规则能将react串联起来</li> <li>a、<strong>遍历的规则</strong> <ul><li>先儿子,后弟弟,在叔叔，</li></ul></li></ul> <img src="/img/fiberconstructortranverse.jpg"> <ul><li>b、<strong>完成链规则</strong> <ul><li>自己所有的子节点完成后完成自己</li></ul></li> <li>c、<strong>effect规则</strong> <ul><li>自己所有的子节点完成后完成自己</li></ul></li></ul> <img src="/img/fibereffectlistwithchild.jpg"> <h3 id="渲染-按照上面的element进行初次渲染-来看下利用这三条规则进行渲染"><a href="#渲染-按照上面的element进行初次渲染-来看下利用这三条规则进行渲染" aria-hidden="true" class="header-anchor">#</a> 渲染 按照上面的element进行初次渲染,来看下利用这三条规则进行渲染</h3> <ul><li><p>遍历节点</p> <ul><li>对于每个有变化的节点,都会创建虚拟DOM生成，同时创建fiber,生成fiber树，此时的fiber结构有个属性保存着下一个兄弟节点(若有)</li> <li>深度递归遍历，只要有儿子就一直递归下去,没有儿子的时候会让自己完成,在去查看是否有下一个兄弟节点,若没有即返回父节点</li> <li>在完成的时候 firstEffect指向第一个完成的节点, lastEffect始终指向最后一个变化节点,每个完成的节点.nextEffect指向下一个完成的节点,这样所有发生副作用的fiber都会被收集到链表中</li> <li>第一个<code>1完成</code>的元素即是(A1 text) 在遍历的时候 他是首个没有child的元素,接着找他的兄弟元素(B1 div),同样(B1 text)是第二个的个<code>2完成</code>,接着找兄弟节点(C1 div),此时的(C1 text)就是第三个<code>3完成</code>的节点</li> <li>(C1 text)完成后,没有儿子节点也没有兄弟节点,即返回父节点(C1 div)<code>4完成</code>。他会去找叔叔的(C2 div),此时(C2 text)<code>5完成</code>,同样(C2 text)没有兄弟和儿子节点,返回(C2 div)即父节点<code>6完成</code></li> <li>(B1 div)里面的儿子都完成自己就<code>7完成</code>了,他会去找自己的兄弟节点(B2 div),那么(B2 text)<code>8完成</code>,接着就是(B2 div)<code>9完成</code>,最后就是(A1 div)<code>10完成</code></li> <li>此流程对应了上图中的(A1 text=&gt; A1)的过程,下面有打印的过程</li></ul></li> <li><p>渲染
<img src="/img/fibereffectlistabc.png"></p></li> <li><p>render阶段 就是把虚拟DOM 转成 Fiber树,在根据Effect list 渲染</p></li> <li><p>核心 mock fiber</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 入口</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>
<span class="token comment">/*
  从根节点开始渲染和调度
  两个阶段
  diff阶段 对比新旧的虚拟DOM  进行增重 更新或创建 render阶段
    这个阶段可以比较花时间,我们可以对任务进行拆分,拆分的维度虚拟DOM。此阶段可以暂停
  render阶段成功是effect list知道哪些节点更新 哪些节点删除了 哪些节点增加了 
  render阶段有两个任务1、根据虚拟DOM生成fiber树 2、收集effectList
  commit阶段,进行DOM更新创建阶段,此阶段不能暂停,要一气呵成
*/</span>
<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 下一个工作单元</span>
<span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// RootFiber引用的根</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//{tag:TAG_ROOT,stateNode:container,props:{children:[element]}}</span>
  workInProgressRoot <span class="token operator">=</span> rootFiber
  nextUnitOfWork <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 执行当前单元节点</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 开始遍历当前的fiber的children 为每一个child配置成fiber 每个child之前通过 sibling 进行连接(大哥.sibling=二哥  二哥.sibling = 三妹)</span>
  <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1、有儿子情况 就返回他的儿子  作为下一个任务 下一个任务又回到 performUnitOfWork 里面</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2、没有儿子情况   就找弟弟</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//没有儿子 让自己完成</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 看有没有弟弟</span>
      <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span><span class="token comment">// 有弟弟就返回弟弟</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3、没有儿子 自己也完成 没有弟弟, 就获取父亲 让父亲完成-&gt;去找他的弟弟(此时儿子都完成了),弟弟有就返回,到此三角形就循环起来了</span>
    currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">// 找父亲 然后让父亲完成</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在完成的时候(第一个是A1)要收集有副作用的fiber,然后组成effect list</span>
<span class="token comment">// 每个fiber有两个属性,firstEffect指向第一个副作用的子fiber lasterEffect指向最后一个有副作用的fiber</span>
<span class="token comment">// 中间的用nextEffect做成一个单链表 firstEffect=大儿子.nextEffect=二儿子.nextEffect=三儿子,lastEffect 也指向三儿子</span>
<span class="token comment">/* 
  completeUnitOfWork 按照这个结构走
  A 
  A(Next)
  B1     B2
  C1 C2  D1  D2
*/</span>
<span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 第一个完成的是A1(TEXT) </span>
  <span class="token comment">// 此处打印所有完成的情况</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'type='</span><span class="token punctuation">,</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token string">'id='</span><span class="token punctuation">,</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">'text='</span><span class="token punctuation">,</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">,</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">// A1(TEXT) 的父亲 是A1</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/////// 这一段是把儿子的effect 链子挂到父亲身上</span>
    <span class="token comment">//当没有父firstEffect没有的时候  让父的firstEffect 等于儿子的 firstEffect</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 根节点的 firstEffect 指向第一个完成的 节点 以后就不会变动了</span>
      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 让兄弟节点(B1)的最后一个.nextEffect 指向兄弟节点(B2)最开始一个.nextEffect</span>
        returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect
      <span class="token punctuation">}</span>
        <span class="token comment">// 根节点的 指向当前节点的 最后一个完成的</span>
        returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect
    <span class="token punctuation">}</span>
    <span class="token comment">/////把自己挂到父亲身上</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//说明自己有副作用 没有的时候 就是新增</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span><span class="token punctuation">{</span>
        returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// lastEffect一直都是在变动的</span>
      returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  <span class="token comment">/*
    beginWork开始收集
    completeUnitOfWork 把下面的都收集完成了
    1、创建真是DOM元素
    2、创建子fiber 
   */</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 如果是根节点</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果是文本节点</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 原生DOM节点</span>
    <span class="token function">updateHost</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateHost</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果此fiber没有创建DOM节点</span>
    currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建真是的节点</span>
<span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 文本节点</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 原生节点</span>
    <span class="token keyword">let</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span>oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 增加 if (stateNode &amp;&amp; stateNode.setAttribute)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stateNode <span class="token operator">&amp;&amp;</span> stateNode<span class="token punctuation">.</span>setAttribute<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 如果此fiber没有创建DOM节点</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 先处理自己, 如果是一个原生节点 创建真实DOM 2、创建子fiber</span>
  <span class="token keyword">let</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//[element=A1]</span>
  <span class="token comment">// 调和节点 这里出创建根节点一个 Fiber</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span>newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//newChildren是一个虚拟DOM的数组 把虚拟DOM转成Fiber节点</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span>newChildren</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 新子节点的索引</span>
  <span class="token comment">// 增加2行</span>
  <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span><span class="token comment">// 上一个新的子fiber</span>
  <span class="token comment">// 遍历我们的子虚拟DOM 元素数组,为每个虚拟DOM元素创建子Fiber</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>newChildIndex<span class="token operator">&lt;</span>newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 取出子元素节点[A1]{type=A1}</span>
    <span class="token keyword">let</span> tag<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">// 这是一个文本节点</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">// 如果type是字符串,那是一个原生的DOM节点</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// beginWork创建fiber 在 completeUnitOfWork 的时候收集effect</span>
    <span class="token keyword">let</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
      tag<span class="token punctuation">,</span><span class="token comment">//TAG_HOST</span>
      type<span class="token punctuation">:</span>newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      props<span class="token punctuation">:</span>newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      stateNode<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// div还没有创建DOM元素</span>
      <span class="token keyword">return</span><span class="token punctuation">:</span>currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span>
      effectTag<span class="token punctuation">:</span><span class="token constant">PLACEMENT</span><span class="token punctuation">,</span><span class="token comment">// 副作用标识,render我们要会收集副作用 增加 删除 更新</span>
      nextEffect<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// effect list 也是一个单链表</span>
      <span class="token comment">// effect list 顺序和完成顺序是一样的 但是节点只放哪些变化的fiber节点,不变化的不会放进去</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最小的儿子是没有弟弟的</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果当前索引为0 说明是第一个儿子</span>
        currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// 让第一儿子 指向他下一个兄弟</span>
        <span class="token comment">// reconcileChildren 只会遍历当前的儿子</span>
        prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      prevSibling <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span>
    newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 循环执行工作 nextUnitWork 不管有沒有任务都会进入 一旦检测到nextUnitOfWork 有值就执行逻辑</span>
<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadLine</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//是否要让出时间片或者说控制权</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span><span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行完一个任务后</span>
    shouldYield <span class="token operator">=</span> deadLine<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 没有时间的话 就要让出控制权</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果时间片到期后还有任务没有完成,就需要请求浏览器再次调度</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 不管有没有任务 都请求再次调度 每一帧都要执行一次workLoop</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">,</span><span class="token punctuation">{</span>timeout<span class="token punctuation">:</span><span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect 
  <span class="token keyword">while</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">let</span> returnDOM <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    returnDOM<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// react告诉浏览器 我现在有任务请你在闲的时候</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">,</span><span class="token punctuation">{</span>timeout<span class="token punctuation">:</span><span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="更新"><a href="#更新" aria-hidden="true" class="header-anchor">#</a> 更新</h2> <ul><li>在第一次更新之前 commitRoot 的时候 workInProgressRoot(渲染时候的fiberRoot) 会保存在currenRoot(当前页面显示的fiberRoot)中,在更新的时候  workInProgressRoot指向更新时的fiberRoot,fiberRoot属性(alternate)指向currentRoot(老的),他会进入到reconcileChildren(创建fiber),在这里他会通过fiberRoot.alternate获取来的老根节点,通过新老fiberRoot进行对比,当创建的fiber,有一个属性alternate指向老节点的fiber</li></ul> <p>fiber都 那么创建newFiber对象的时候会多一个alternate属性,他指向oldFiber,新fiber递归创建,他里面的alternate属性都指向同级的oldFiber,每一个新fiber都有一个指针指向oldFiber,等待所有的effect收集完成,用currentFiber.alternate.props和currentFiber.props进行DOM更新</p> <ul><li>在第二次更新的时候,
<img src="/img/updatecomponent.jpg"></li></ul> <h3 id="双缓存机制"><a href="#双缓存机制" aria-hidden="true" class="header-anchor">#</a> 双缓存机制</h3> <img src="/img/alternate.jpg"></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/28/2020, 9:50:38 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/article/reactSource.html" class="prev">
          react source
        </a></span> <span class="next"><a href="/article/vueSource.html">
          vue source
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.2d5a21ba.js" defer></script><script src="/assets/js/12.e2a162e2.js" defer></script>
  </body>
</html>
