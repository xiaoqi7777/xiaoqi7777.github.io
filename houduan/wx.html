<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信公众号 | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.eab45adb.css" as="style"><link rel="preload" href="/assets/js/app.2d5a21ba.js" as="script"><link rel="preload" href="/assets/js/57.8b4691e9.js" as="script"><link rel="prefetch" href="/assets/js/10.8a362e98.js"><link rel="prefetch" href="/assets/js/11.d74a0997.js"><link rel="prefetch" href="/assets/js/12.e2a162e2.js"><link rel="prefetch" href="/assets/js/13.84c6fa39.js"><link rel="prefetch" href="/assets/js/14.c4eac9aa.js"><link rel="prefetch" href="/assets/js/15.6e106e89.js"><link rel="prefetch" href="/assets/js/16.9e29e9f1.js"><link rel="prefetch" href="/assets/js/17.9b3a8933.js"><link rel="prefetch" href="/assets/js/18.f0190824.js"><link rel="prefetch" href="/assets/js/19.9e8ce3c8.js"><link rel="prefetch" href="/assets/js/2.39847600.js"><link rel="prefetch" href="/assets/js/20.f1e6b579.js"><link rel="prefetch" href="/assets/js/21.f06a428f.js"><link rel="prefetch" href="/assets/js/22.e8fff36c.js"><link rel="prefetch" href="/assets/js/23.9be9c45e.js"><link rel="prefetch" href="/assets/js/24.b1a2e86a.js"><link rel="prefetch" href="/assets/js/25.2721ff74.js"><link rel="prefetch" href="/assets/js/26.2cca1f22.js"><link rel="prefetch" href="/assets/js/27.60ac312a.js"><link rel="prefetch" href="/assets/js/28.a51bcc0b.js"><link rel="prefetch" href="/assets/js/29.d4d7922b.js"><link rel="prefetch" href="/assets/js/3.e8366ca8.js"><link rel="prefetch" href="/assets/js/30.284529e8.js"><link rel="prefetch" href="/assets/js/31.329482e5.js"><link rel="prefetch" href="/assets/js/32.1dd41dba.js"><link rel="prefetch" href="/assets/js/33.cdaf88aa.js"><link rel="prefetch" href="/assets/js/34.d2260297.js"><link rel="prefetch" href="/assets/js/35.0f100cdc.js"><link rel="prefetch" href="/assets/js/36.2d7b8183.js"><link rel="prefetch" href="/assets/js/37.58e42fab.js"><link rel="prefetch" href="/assets/js/38.b702c8f5.js"><link rel="prefetch" href="/assets/js/39.82cf90ef.js"><link rel="prefetch" href="/assets/js/4.f13a62f3.js"><link rel="prefetch" href="/assets/js/40.5e523f7a.js"><link rel="prefetch" href="/assets/js/41.bdd3935e.js"><link rel="prefetch" href="/assets/js/42.38f97d1a.js"><link rel="prefetch" href="/assets/js/43.fde099dd.js"><link rel="prefetch" href="/assets/js/44.1c37dd97.js"><link rel="prefetch" href="/assets/js/45.98b02b2e.js"><link rel="prefetch" href="/assets/js/46.42f3fcd7.js"><link rel="prefetch" href="/assets/js/47.e82a83b5.js"><link rel="prefetch" href="/assets/js/48.198aa16b.js"><link rel="prefetch" href="/assets/js/49.584f6640.js"><link rel="prefetch" href="/assets/js/5.1ee23f75.js"><link rel="prefetch" href="/assets/js/50.8b31f4da.js"><link rel="prefetch" href="/assets/js/51.78f5d0ad.js"><link rel="prefetch" href="/assets/js/52.31174a6a.js"><link rel="prefetch" href="/assets/js/53.077bd356.js"><link rel="prefetch" href="/assets/js/54.3de7f928.js"><link rel="prefetch" href="/assets/js/55.3ad4df39.js"><link rel="prefetch" href="/assets/js/56.785eabef.js"><link rel="prefetch" href="/assets/js/58.f7997b54.js"><link rel="prefetch" href="/assets/js/59.d7a4d8a8.js"><link rel="prefetch" href="/assets/js/6.705f6278.js"><link rel="prefetch" href="/assets/js/60.ddb9f94c.js"><link rel="prefetch" href="/assets/js/61.26981a47.js"><link rel="prefetch" href="/assets/js/62.3f032d2a.js"><link rel="prefetch" href="/assets/js/63.39527714.js"><link rel="prefetch" href="/assets/js/64.8868dd89.js"><link rel="prefetch" href="/assets/js/65.6b974d81.js"><link rel="prefetch" href="/assets/js/66.855c5823.js"><link rel="prefetch" href="/assets/js/67.31e1762e.js"><link rel="prefetch" href="/assets/js/68.8c46b6ac.js"><link rel="prefetch" href="/assets/js/69.86ace7af.js"><link rel="prefetch" href="/assets/js/7.1fd1c381.js"><link rel="prefetch" href="/assets/js/70.351ae70a.js"><link rel="prefetch" href="/assets/js/71.1d26e844.js"><link rel="prefetch" href="/assets/js/72.1df64755.js"><link rel="prefetch" href="/assets/js/73.090c6271.js"><link rel="prefetch" href="/assets/js/74.5788c180.js"><link rel="prefetch" href="/assets/js/75.74f8c6f5.js"><link rel="prefetch" href="/assets/js/76.7e7562cd.js"><link rel="prefetch" href="/assets/js/77.777397ae.js"><link rel="prefetch" href="/assets/js/78.d7cc5ce5.js"><link rel="prefetch" href="/assets/js/79.d294b892.js"><link rel="prefetch" href="/assets/js/8.60fbcf9b.js"><link rel="prefetch" href="/assets/js/80.99fd18d4.js"><link rel="prefetch" href="/assets/js/81.2c0e2273.js"><link rel="prefetch" href="/assets/js/9.c9c66d36.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eab45adb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">operation</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>houduan</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/houduan/node.html" class="sidebar-link">node</a></li><li><a href="/houduan/ios.html" class="sidebar-link">ISO</a></li><li><a href="/houduan/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/houduan/egg.html" class="sidebar-link">egg</a></li><li><a href="/houduan/mock.html" class="sidebar-link">Mockjs</a></li><li><a href="/houduan/wx.html" class="active sidebar-link">微信公众号</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/houduan/wx.html#对接微信后端" class="sidebar-link">对接微信后端</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#服务器接受微信端的信息" class="sidebar-link">服务器接受微信端的信息</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#回复消息" class="sidebar-link">回复消息</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#获取-access-token-票据" class="sidebar-link">获取 access_token 票据</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#页面的菜单设置" class="sidebar-link">页面的菜单设置</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#微信网页授权" class="sidebar-link">微信网页授权</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#sdk签名-很多接口都需要用它照片-录音等" class="sidebar-link">SDK签名(很多接口都需要用它照片,录音等)</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#支付-扫码和微信自身支付" class="sidebar-link">支付(扫码和微信自身支付)</a></li><li class="sidebar-sub-header"><a href="/houduan/wx.html#代码-sdk验证-auth验证-支付" class="sidebar-link">代码(sdk验证&amp;&amp;auth验证&amp;&amp;支付)</a></li></ul></li><li><a href="/houduan/koa.html" class="sidebar-link">koa原理</a></li><li><a href="/houduan/http.html" class="sidebar-link">http</a></li><li><a href="/houduan/mysql.html" class="sidebar-link">mysql</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="微信公众号"><a href="#微信公众号" aria-hidden="true" class="header-anchor">#</a> 微信公众号</h1> <p></p><div class="table-of-contents"><ul><li><a href="#对接微信后端">对接微信后端</a></li><li><a href="#服务器接受微信端的信息">服务器接受微信端的信息</a></li><li><a href="#回复消息">回复消息</a></li><li><a href="#获取-access-token-票据">获取 access_token 票据</a></li><li><a href="#页面的菜单设置">页面的菜单设置</a></li><li><a href="#微信网页授权">微信网页授权</a></li><li><a href="#sdk签名-很多接口都需要用它照片-录音等">SDK签名(很多接口都需要用它照片,录音等)</a><ul><li><a href="#前端处理">前端处理</a></li></ul></li><li><a href="#支付-扫码和微信自身支付">支付(扫码和微信自身支付)</a></li><li><a href="#代码-sdk验证-auth验证-支付">代码(sdk验证&amp;&amp;auth验证&amp;&amp;支付)</a></li></ul></div><p></p> <h2 id="对接微信后端"><a href="#对接微信后端" aria-hidden="true" class="header-anchor">#</a> 对接微信后端</h2> <ul><li>服务器配置
<ul><li>位子:基本配置-&gt;服务器配置</li> <li>服务器地址(URL) 地址是自己服务器可以方位的路径</li> <li>加密选择文明模式 (sha1算法)</li> <li>首次接入 看 firstAuthentication路由,get方式 基本就用这一次</li></ul></li></ul> <h2 id="服务器接受微信端的信息"><a href="#服务器接受微信端的信息" aria-hidden="true" class="header-anchor">#</a> 服务器接受微信端的信息</h2> <ul><li>跟首次接入一样的firstAuthentication路由 用post,往后的接收消息基本用这个</li> <li>与微信交流的格式不是JSON,是XML
<ul><li>主要用 xml-js 库来转换</li> <li>xml2js(xml转js) js2xml(js转换xml)</li></ul></li> <li>接收微信的消息 raw-body 库处理,也可以监听流,自己写 里面有写(与raw-body在一块被注释了)</li> <li>和微信交流常用字符
<ul><li>ToUserName 发给谁</li> <li>FromUserName 是谁发的</li> <li>CreateTime 时间戳</li> <li>MsgType 类型</li> <li>Content 内容</li></ul></li></ul> <h2 id="回复消息"><a href="#回复消息" aria-hidden="true" class="header-anchor">#</a> 回复消息</h2> <ul><li>微信回复的消息类型 大概7种 文字,图片,图文,视频,语音等</li> <li>在wecaht/tpl中 我用 ejs 和 heredoc 封装了 在wecaht/text有调用的方法 传入一个对象</li> <li>主要xml格式 官网里面有坑 语法里面没有空格  官网例子有空格</li></ul> <h2 id="获取-access-token-票据"><a href="#获取-access-token-票据" aria-hidden="true" class="header-anchor">#</a> 获取 access_token 票据</h2> <ul><li>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token</li> <li>获取的 access_token 我把他写到本地了</li> <li>特点 7200m 失效</li> <li>getToken=&gt;wxInit/index.js</li></ul> <h2 id="页面的菜单设置"><a href="#页面的菜单设置" aria-hidden="true" class="header-anchor">#</a> 页面的菜单设置</h2> <ul><li>写一个JSON 通过接口提交就可以了</li> <li>如果手机没有显示 取消重新关注即可</li> <li>createMenu =&gt; wxInit/index.js</li></ul> <h2 id="微信网页授权"><a href="#微信网页授权" aria-hidden="true" class="header-anchor">#</a> 微信网页授权</h2> <ul><li>微信网页授权是auth验证</li> <li>前端 设置(看官网配置)
<ul><li>redirect_uri 就是前端网站自己</li> <li>scope 选一种</li> <li>初始化的时候 跳转这个地址就会进行验证</li></ul></li> <li>认证后 通过url获取当前的code 传给后端,后端用他可以换取openid,微信自身支付需要他</li></ul> <h2 id="sdk签名-很多接口都需要用它照片-录音等"><a href="#sdk签名-很多接口都需要用它照片-录音等" aria-hidden="true" class="header-anchor">#</a> SDK签名(很多接口都需要用它照片,录音等)</h2> <ul><li>sdk前面需要4个参数进行签名
<ul><li>nonce_str 生成签名的随机串</li> <li>timeStamp 生成签名的时间戳</li> <li>jsapiTicket 用普通票据换的sdk票据</li> <li>url 当前网站 #及其后面的不要</li></ul></li> <li>sdkSignHandle SDK签名算法
<ul><li>字典排序 用&amp;连接</li> <li>在用sha1算法即可</li></ul></li></ul> <h3 id="前端处理"><a href="#前端处理" aria-hidden="true" class="header-anchor">#</a> 前端处理</h3> <ul><li>index.html 引入</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://res.wx.qq.com/open/js/jweixin-1.4.0.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><ul><li>前端获取签名,时间戳,随机串等</li> <li>设置wx.config
<ul><li>jsApiList里面填写使用的接口</li> <li>具体看官网</li></ul></li></ul> <h2 id="支付-扫码和微信自身支付"><a href="#支付-扫码和微信自身支付" aria-hidden="true" class="header-anchor">#</a> 支付(扫码和微信自身支付)</h2> <ul><li>扫描
<ul><li>提前准备 一些参数 官网上有</li> <li>获取 商品支付信息和key 进行签名算法(util.wxSign)
<ul><li>算法
<ul><li>将订单商品进行排序(按照key值)</li> <li>用querystring库将他变成字符</li> <li>字符串+&amp;key='key'</li> <li>通过md5进行签名 即可</li></ul></li></ul></li> <li>签名和商品转换成xml 发给微信(下单)</li> <li>接收到的参数转换成js 里面有一个 code_url</li> <li>用 qrcode 将code_url转换成一个 二维码发给前端显示</li></ul></li> <li>h5支付
<ul><li>需要 openid 获取openid 的时候 赋值给order上</li> <li>提前准备 一些参数 官网上有</li> <li>获取 商品支付信息和key 进行签名算法(util.wxSign)
<ul><li>算法
<ul><li>将订单商品进行排序(按照key值)</li> <li>用querystring库将他变成字符</li> <li>字符串+&amp;key='key'</li> <li>通过md5进行签名 即可</li></ul></li></ul></li> <li>签名和商品转换成xml 发给微信(下单)</li> <li>接收到的参数转换成js 里面有一个 prepay_id</li> <li>用prepay_id 和一些参数 再次进行md5 加密</li> <li>最后接口返回一个json格式就可以了</li></ul></li> <li>支付完成 微信会有一个支付信息的信息发过来 getNotifyUrl接口</li></ul> <h2 id="代码-sdk验证-auth验证-支付"><a href="#代码-sdk验证-auth验证-支付" aria-hidden="true" class="header-anchor">#</a> 代码(sdk验证&amp;&amp;auth验证&amp;&amp;支付)</h2> <ul><li><p>dist</p> <ul><li>前端代码</li></ul></li> <li><p>router</p> <ul><li>util.js</li> <li>wxpay.js</li></ul></li> <li><p>wechat</p> <ul><li>text.js</li> <li>tpl.js</li></ul></li> <li><p>wxInit</p> <ul><li>index.js</li> <li>util.js</li></ul></li> <li><p>app.js</p></li> <li><p>config.js</p></li> <li><p>logger.js</p></li> <li><p>app.js(入口文件)</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span>  Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>  
<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> wxInit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./wxInit'</span><span class="token punctuation">)</span>
wxInit<span class="token punctuation">.</span><span class="token function">entryFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> routerWx <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/wx'</span><span class="token punctuation">)</span>

<span class="token comment">// post 提交处理</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  enableTypes<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 静态文件处理</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> __dirname<span class="token punctuation">,</span>  <span class="token string">'/dist'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/wx'</span><span class="token punctuation">,</span>routerWx<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'跑起来了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>config.js 配置文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  wechat<span class="token punctuation">:</span><span class="token punctuation">{</span>
    appID <span class="token punctuation">:</span> <span class="token string">'wx3df629936bf31f75'</span><span class="token punctuation">,</span>
    appSecret <span class="token punctuation">:</span> <span class="token string">'036989030fec913af6365b7695ffa918'</span><span class="token punctuation">,</span>
    token <span class="token punctuation">:</span> <span class="token string">'sg92322'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  wxpay<span class="token punctuation">:</span><span class="token punctuation">{</span>
    mch_id<span class="token punctuation">:</span> <span class="token string">'1511047841'</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">'gmklNxpgLPCQrOxji2HzIThpAfiyIVx7 '</span><span class="token punctuation">,</span>
    notify_url<span class="token punctuation">:</span> <span class="token string">'http://tsml520.cn/wx/getNotifyUrl'</span><span class="token punctuation">,</span>
    unifiedorder<span class="token punctuation">:</span><span class="token string">'https://api.mch.weixin.qq.com/pay/unifiedorder'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config
</code></pre></div><ul><li>loggers日志文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> bunyan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bunyan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">make_logger</span><span class="token punctuation">(</span><span class="token parameter">app_name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> logger <span class="token operator">=</span> bunyan<span class="token punctuation">.</span><span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> app_name<span class="token punctuation">,</span>
    streams<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">'rotating-file'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'./logs/'</span><span class="token operator">+</span>app_name<span class="token operator">+</span><span class="token string">'.log'</span><span class="token punctuation">,</span>
      period<span class="token punctuation">:</span> <span class="token string">'1d'</span><span class="token punctuation">,</span>   <span class="token comment">// daily rotation</span>
      count<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token comment">// keep 3 back copies</span>
      level<span class="token punctuation">:</span> <span class="token string">'trace'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> logger<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">make_logger</span><span class="token punctuation">(</span><span class="token string">'sg_wxgzh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> logger
</code></pre></div><ul><li>wxInit/index.js 初始化</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> pathAdress <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../txt.js'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> data <span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token string">&quot;button&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>    
       <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;今日歌曲&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1001_TODAY_MUSIC&quot;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;我的网站&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;http://tsml520.cn&quot;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;菜单&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;sub_button&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
         <span class="token punctuation">{</span>
              <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;pic_photo_or_album&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;11&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1001_GOOD&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
              <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;scancode_waitmsg&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;扫码&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1002_GOOD&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;location_select&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;发送位子&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1003_GOOD&quot;</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;pic_sysphoto&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;拍照&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1004_GOOD&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;pic_weixin&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;弹出相框&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;V1005_GOOD&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取票据</span>
<span class="token keyword">async</span> <span class="token keyword">function</span>  <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> appID <span class="token operator">=</span><span class="token string">'wx3df629936bf31f75'</span>
  <span class="token keyword">let</span> appSecret <span class="token operator">=</span><span class="token string">'036989030fec913af6365b7695ffa918'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
  data <span class="token operator">=</span> data<span class="token punctuation">.</span>data
  <span class="token keyword">let</span> time2h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span>
  <span class="token keyword">let</span> expires <span class="token operator">=</span> data<span class="token punctuation">.</span>expires_in

  time2h <span class="token operator">=</span> <span class="token punctuation">(</span>time2h<span class="token operator">+</span>expires<span class="token operator">-</span><span class="token number">200</span><span class="token punctuation">)</span> 
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> data<span class="token punctuation">.</span>access_token
  <span class="token keyword">let</span> accessData <span class="token operator">=</span> <span class="token punctuation">[</span>time2h<span class="token punctuation">,</span>accessToken<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>

  <span class="token keyword">await</span> util<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>pathAdress<span class="token punctuation">,</span>accessData<span class="token punctuation">)</span>

  <span class="token keyword">return</span> accessToken
<span class="token punctuation">}</span>

<span class="token comment">// 检查token是否有效</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> accessData <span class="token operator">=</span><span class="token keyword">await</span> util<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>pathAdress<span class="token punctuation">)</span>
  accessData <span class="token operator">=</span> accessData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> time2h <span class="token operator">=</span> accessData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> accessData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  
  <span class="token keyword">let</span> currentTime2h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>time2h<span class="token operator">&gt;</span>currentTime2h<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> accessToken
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义菜单</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">validToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get accessToken'</span><span class="token punctuation">,</span>accessToken<span class="token punctuation">)</span>

  <span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token template-string"><span class="token string">` https://api.weixin.qq.com/cgi-bin/menu/create?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
  rs <span class="token operator">=</span> rs<span class="token punctuation">.</span>data
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'createMenu'</span><span class="token punctuation">,</span>rs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//获取sdk</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sdkToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token constant">ACCESS_TOKEN</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ACCESS_TOKEN</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=jsapi`</span></span>
  <span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
  <span class="token keyword">return</span> rs<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">entryFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">createMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entryFn<span class="token punctuation">,</span>
  validToken<span class="token punctuation">,</span>
  sdkToken
<span class="token punctuation">}</span>
</code></pre></div><ul><li>wxInit/util.js 处理token的读写</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> pathAdress <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../txt.js'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span>_path<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>_path<span class="token punctuation">,</span>encoding<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>context</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token parameter">_path<span class="token punctuation">,</span>context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span>  fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>_path<span class="token punctuation">,</span>context<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    readFile<span class="token punctuation">,</span>
    writeFile
<span class="token punctuation">}</span>
</code></pre></div><ul><li>wechat/text.js 微信聊天</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> tpl <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./tpl'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">textReply</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 回复处理-------------</span>
  <span class="token keyword">let</span> ToUserName <span class="token operator">=</span> data<span class="token punctuation">.</span>FromUserName
  <span class="token keyword">let</span> FromUserName <span class="token operator">=</span> data<span class="token punctuation">.</span>ToUserName
  <span class="token keyword">let</span> Content <span class="token operator">=</span> data<span class="token punctuation">.</span>Content


  <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token string">'text'</span>
  info<span class="token punctuation">.</span>content <span class="token operator">=</span> Content
  info<span class="token punctuation">.</span>createTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  info<span class="token punctuation">.</span>msgType <span class="token operator">=</span> type
  info<span class="token punctuation">.</span>toUserName <span class="token operator">=</span> ToUserName
  info<span class="token punctuation">.</span>fromUserName <span class="token operator">=</span> FromUserName

  <span class="token keyword">let</span> rs <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">compiled</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> rs
  <span class="token comment">// ctx.body = `</span>
  <span class="token comment">// &lt;xml&gt; </span>
  <span class="token comment">//   &lt;ToUserName&gt;&lt;![CDATA[${ToUserName}]]&gt;&lt;/ToUserName&gt; </span>
  <span class="token comment">//   &lt;FromUserName&gt;&lt;![CDATA[${FromUserName}]]&gt;&lt;/FromUserName&gt; </span>
  <span class="token comment">//   &lt;CreateTime&gt;${new Date().getTime()}&lt;/CreateTime&gt; </span>
  <span class="token comment">//   &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt; </span>
  <span class="token comment">//   &lt;Content&gt;&lt;![CDATA[${Content}]]&gt;&lt;/Content&gt; </span>
  <span class="token comment">// &lt;/xml&gt;</span>
  <span class="token comment">// `</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>wechat/tpl.js 封装回复信息</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 作用编译模板</span>
<span class="token keyword">var</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ejs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用写模版</span>
<span class="token keyword">var</span> heredoc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;heredoc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> tpl <span class="token operator">=</span> <span class="token function">heredoc</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 
    &lt;xml&gt; &lt;ToUserName&gt;&lt;![CDATA[&lt;%= toUserName %&gt;]]&gt;&lt;/ToUserName&gt; 
    &lt;FromUserName&gt;&lt;![CDATA[&lt;%= fromUserName %&gt;]]&gt;&lt;/FromUserName&gt; 
    &lt;CreateTime&gt;&lt;%= createTime %&gt;&lt;/CreateTime&gt;
    &lt;MsgType&gt;&lt;![CDATA[&lt;%= msgType %&gt;]]&gt;&lt;/MsgType&gt; 
    &lt;% if (msgType === 'text') { %&gt; 
      &lt;Content&gt;&lt;![CDATA[&lt;%= content%&gt;]]&gt;&lt;/Content&gt; 
    &lt;% } else if (msgType === 'image') {%&gt;
      &lt;Image&gt;
        &lt;MediaId&gt;&lt;![CDATA[&lt;%= content.mediaId %&gt;]]&gt;&lt;/MediaId&gt;
      &lt;/Image&gt;
    &lt;% } else if (msgType === 'voice') {%&gt;
      &lt;Voice&gt;
        &lt;MediaId&gt;&lt;![CDATA[&lt;%= content.mediaId %&gt;]]&gt;&lt;/MediaId&gt;
      &lt;/Voice&gt;
    &lt;% } else if (msgType === 'video') {%&gt;
      &lt;Video&gt;
        &lt;MediaId&gt;&lt;![CDATA[&lt;%= content.mediaId %&gt;]]&gt;&lt;/MediaId&gt;
        &lt;Title&gt;&lt;![CDATA[&lt;%= content.title %&gt;]]&gt;&lt;/Title&gt;
        &lt;Description&gt;&lt; ![CDATA[[&lt;%= content.description %&gt;]]&gt;&lt;/Description&gt;
      &lt;/Video&gt;
    &lt;% } else if (msgType === 'music') {%&gt;
      &lt;Music&gt;
        &lt;Title&gt;&lt;![CDATA[&lt;%= content.title %&gt;]]&gt;&lt;/Title&gt;
        &lt;Description&gt;&lt;![CDATA[&lt;%= content.description %&gt;]]&gt;&lt;/Description&gt;
        &lt;MusicUrl&gt;&lt;![CDATA[&lt;%= content.musicUrl%&gt;]]&gt;&lt;/MusicUrl&gt;
        &lt;HQMusicUrl&gt;&lt;![CDATA[&lt;%= content.hqMusicUrl%&gt;]]&gt;&lt;/HQMusicUrl&gt;
        &lt;ThumbMediaId&gt;&lt;![CDATA[&lt;%= content.thumbMediaId %&gt;]]&gt;&lt;/ThumbMediaId&gt;
      &lt;/Music&gt;
    &lt;% } else if (msgType === 'news') {%&gt;
      &lt;ArticleCount&gt;&lt;%= content.length %&gt;&lt;/ArticleCount&gt;
      &lt;Articles&gt;
      &lt;% content.forEach(function(item){%&gt;
        &lt;item&gt;
          &lt;Title&gt;&lt; ![CDATA[&lt;%= item.title%&gt;]]&gt;&lt;/Title&gt; 
          &lt;Description&gt;&lt; ![CDATA[&lt;%= item.description%&gt;]]&gt;&lt;/Description&gt;
          &lt;PicUrl&gt;&lt; ![CDATA[&lt;%= item.picUrl%&gt;] ]&gt;&lt;/PicUrl&gt;
          &lt;Url&gt;&lt; ![CDATA[&lt;%= item.url%&gt;] ]&gt;&lt;/Url&gt;
        &lt;/item&gt;
      &lt;% }) %&gt;
      &lt;/Articles&gt;
    &lt;% } %&gt;
  &lt;/xml&gt;
*/</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> compiled <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>tpl<span class="token punctuation">)</span>
exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  compiled
<span class="token punctuation">}</span>
</code></pre></div><ul><li>router/wx.js 路由</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token comment">//产生随机数</span>
<span class="token keyword">const</span> randomstring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'randomstring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// xml和js互相转化</span>
<span class="token keyword">const</span> xmljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//回复</span>
<span class="token keyword">const</span> wechat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../wechat/text'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> wx <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../wxInit'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> qrcode <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qrcode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root_logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../logger'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> root_logger<span class="token punctuation">.</span><span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">'router'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> nonce_str <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">// 随机字符串</span>
<span class="token keyword">let</span> timeStamp <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//时间戳</span>
<span class="token keyword">let</span> out_trade_no <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDDhhmmss'</span><span class="token punctuation">)</span> <span class="token comment">//商户订单号</span>

<span class="token keyword">let</span> appSecret <span class="token operator">=</span> config<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>appSecret<span class="token punctuation">;</span>
<span class="token keyword">let</span> appid <span class="token operator">=</span> config<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>appID<span class="token punctuation">;</span>
<span class="token keyword">let</span> notify_url <span class="token operator">=</span> config<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>notify_url<span class="token punctuation">;</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> config<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token keyword">let</span> mch_id <span class="token operator">=</span> config<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>mch_id<span class="token punctuation">;</span>
<span class="token keyword">let</span> unifiedorder <span class="token operator">=</span> config<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>unifiedorder<span class="token punctuation">;</span>
<span class="token keyword">let</span> sign <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment">//签名</span>
<span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">'商品名称'</span>
<span class="token keyword">let</span> total_fee <span class="token operator">=</span> <span class="token string">'1'</span>
<span class="token keyword">let</span> detail <span class="token operator">=</span> <span class="token string">'商品详情'</span>
<span class="token keyword">let</span> trade_type <span class="token operator">=</span> <span class="token string">'NATIVE'</span>
<span class="token keyword">let</span> product_id <span class="token operator">=</span> nonce_str


<span class="token keyword">let</span> order <span class="token operator">=</span> <span class="token punctuation">{</span>
  appid<span class="token punctuation">,</span>
  mch_id<span class="token punctuation">,</span>
  out_trade_no<span class="token punctuation">,</span>
  body<span class="token punctuation">,</span>
  total_fee<span class="token punctuation">,</span>
  product_id<span class="token punctuation">,</span>
  notify_url<span class="token punctuation">,</span>
  nonce_str<span class="token punctuation">,</span>
  trade_type<span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token comment">// 微信发过来首次认证是get  以后接受消息都是post 同样的接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/firstAuthentication'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// </span>
  <span class="token keyword">let</span> getData <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
  getData <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">signatureAuthentication</span><span class="token punctuation">(</span>getData<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>getData<span class="token punctuation">.</span>sha <span class="token operator">===</span> getData<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'first authentication pass =&gt;get'</span><span class="token punctuation">)</span>
    <span class="token comment">// 是微信发过来的 将echostr返回过去就可以了</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> getData<span class="token punctuation">.</span>echostr
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非微信</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'wrong'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 根据 code 换登录的openid</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getOpenId'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> x<span class="token punctuation">.</span>query<span class="token punctuation">.</span>code
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/sns/oauth2/access_token?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code`</span></span>
  <span class="token keyword">let</span> getData <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`get openId </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>getData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  order<span class="token punctuation">.</span>openid <span class="token operator">=</span> getData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid
  x<span class="token punctuation">.</span>body <span class="token operator">=</span> getData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/sdk'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> ctx<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?url='</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> ctx<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token operator">+</span><span class="token string">'?url='</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">let</span> jsapiTicket <span class="token operator">=</span> <span class="token keyword">await</span> wx<span class="token punctuation">.</span><span class="token function">sdkToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`sdk sign parameter,nonce_str=&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nonce_str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,timeStamp=&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timeStamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,sdkToken=&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsapiTicket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,url=&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> rs <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">sdkSignHandle</span><span class="token punctuation">(</span>nonce_str<span class="token punctuation">,</span>timeStamp<span class="token punctuation">,</span>jsapiTicket<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span>  rs
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/firstAuthentication'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> getData <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
  getData <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">signatureAuthentication</span><span class="token punctuation">(</span>getData<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>getData<span class="token punctuation">.</span>sha <span class="token operator">===</span> getData<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> util<span class="token punctuation">.</span><span class="token function">parseXML</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// textKey 和 cdataKey 配置 是为了获取的结果里面的key是转换成value </span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      compact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      textKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
      cdataKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//xml转js</span>
    <span class="token keyword">let</span> jsData <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token comment">//转正常用的对象</span>
    jsData <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">transformXmlFn</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`接受的信息 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsData<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token comment">//回复处理</span>
    wechat<span class="token punctuation">.</span><span class="token function">textReply</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>jsData<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'wrong'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//h5支付</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/commonPay'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> paySubmitInfo <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
  total_fee <span class="token operator">=</span> order<span class="token punctuation">.</span>total_fee <span class="token operator">=</span> paySubmitInfo<span class="token punctuation">.</span>money
  trade_type <span class="token operator">=</span> order<span class="token punctuation">.</span>trade_type <span class="token operator">=</span> <span class="token string">'JSAPI'</span>
  product_id <span class="token operator">=</span> order<span class="token punctuation">.</span>product_id <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
  out_trade_no <span class="token operator">=</span> order<span class="token punctuation">.</span>out_trade_no <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDDhhmmss'</span><span class="token punctuation">)</span> 
  body <span class="token operator">=</span> order<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'暂时=&gt;'</span><span class="token operator">+</span>randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`commonPay parameter`</span></span><span class="token punctuation">,</span>order<span class="token punctuation">)</span>

  sign <span class="token operator">=</span>  util<span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> key<span class="token punctuation">)</span>

  <span class="token keyword">let</span> xmlOrder <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    xml<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
      <span class="token operator">...</span>order<span class="token punctuation">,</span>
      sign
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      compact<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 下单</span>
  <span class="token keyword">let</span> unifiedorderResponse  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>unifiedorder<span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> _prepay <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        compact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        cdataKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
        textKey<span class="token punctuation">:</span><span class="token string">'value'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 

  <span class="token comment">//将获取的xml转换成js</span>
  <span class="token keyword">let</span> prepay  <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">transformXmlFn</span><span class="token punctuation">(</span>_prepay<span class="token punctuation">)</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`支付返回的信息 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prepay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> prepay_id <span class="token operator">=</span> prepay<span class="token punctuation">.</span>prepay_id

  <span class="token keyword">let</span> params<span class="token punctuation">;</span>
  params <span class="token operator">=</span> <span class="token punctuation">{</span>
    appId<span class="token punctuation">:</span>appid<span class="token punctuation">,</span>
    timeStamp<span class="token punctuation">:</span>timeStamp<span class="token punctuation">,</span>
    nonceStr<span class="token punctuation">:</span>nonce_str<span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span><span class="token template-string"><span class="token string">`prepay_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prepay_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    signType <span class="token punctuation">:</span> <span class="token string">'MD5'</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//签名</span>
  sign <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span>key<span class="token punctuation">)</span>

  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    appId<span class="token punctuation">:</span>appid<span class="token punctuation">,</span>
    timeStamp<span class="token punctuation">:</span> timeStamp<span class="token punctuation">,</span> <span class="token comment">//时间戳，自1970年以来的秒数</span>
    nonceStr<span class="token punctuation">:</span> nonce_str<span class="token punctuation">,</span> <span class="token comment">//随机串</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span> prepay_id<span class="token punctuation">,</span>
    signType<span class="token punctuation">:</span> <span class="token string">&quot;MD5&quot;</span><span class="token punctuation">,</span> <span class="token comment">//微信签名方式：</span>
    paySign<span class="token punctuation">:</span> sign <span class="token comment">//微信签名</span>
  <span class="token punctuation">}</span>

  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> obj
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 扫描支付</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/scanPay'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> paySubmitInfo <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
  total_fee <span class="token operator">=</span> order<span class="token punctuation">.</span>total_fee <span class="token operator">=</span> paySubmitInfo<span class="token punctuation">.</span>money
  trade_type <span class="token operator">=</span> order<span class="token punctuation">.</span>trade_type <span class="token operator">=</span> <span class="token string">'NATIVE'</span>
  product_id <span class="token operator">=</span> order<span class="token punctuation">.</span>product_id <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
  out_trade_no <span class="token operator">=</span> order<span class="token punctuation">.</span>out_trade_no <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDDhhmmss'</span><span class="token punctuation">)</span> 
  body <span class="token operator">=</span> order<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'暂时=&gt;'</span><span class="token operator">+</span>randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`commonPay parameter </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1支付商品的信息'</span><span class="token punctuation">,</span>order<span class="token punctuation">)</span>
  <span class="token comment">//获取签名</span>
  sign <span class="token operator">=</span>  util<span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token comment">//转换成 xml 格式</span>
  <span class="token keyword">let</span> xmlOrder <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    xml<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
      <span class="token operator">...</span>order<span class="token punctuation">,</span>
      sign
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      compact<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//请求统一下单接口 (2个参数 发送地址 xml格式的订单)</span>
  <span class="token keyword">let</span> unifiedorderResponse  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>unifiedorder<span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//响应的 数据是一个xml格式的</span>
  <span class="token keyword">let</span> _prepay <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                  compact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  cdataKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
                  textKey<span class="token punctuation">:</span><span class="token string">'value'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token comment">//console.log('将获取的xml数据转换成js对象',_prepay)</span>
  
  <span class="token comment">//将获取的xml转换成对象</span>
  <span class="token keyword">let</span> prepay  <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">transformXmlFn</span><span class="token punctuation">(</span>_prepay<span class="token punctuation">)</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'2调取支付微信返回的结果'</span><span class="token punctuation">,</span>prepay<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2调取支付微信返回的结果'</span><span class="token punctuation">,</span>prepay<span class="token punctuation">)</span>
  <span class="token keyword">let</span> code_url <span class="token operator">=</span> prepay<span class="token punctuation">.</span>code_url
  <span class="token keyword">const</span> qrcodeUrl <span class="token operator">=</span> <span class="token keyword">await</span> qrcode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>code_url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      width<span class="token punctuation">:</span> <span class="token number">300</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> qrcodeUrl
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/getNotifyUrl'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> util<span class="token punctuation">.</span><span class="token function">parseXML</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    compact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    textKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
    cdataKey<span class="token punctuation">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> jsData <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
  <span class="token keyword">let</span> payment <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">transformXmlFn</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付成功返回的数据'</span><span class="token punctuation">,</span>payment<span class="token punctuation">)</span>
  <span class="token keyword">const</span> paymentSign <span class="token operator">=</span> payment<span class="token punctuation">.</span>sign
  <span class="token keyword">delete</span> payment<span class="token punctuation">.</span>sign
  <span class="token keyword">let</span> key  <span class="token operator">=</span> <span class="token string">'gmklNxpgLPCQrOxji2HzIThpAfiyIVx7'</span>
  <span class="token keyword">let</span> newSign <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>payment<span class="token punctuation">,</span>key<span class="token punctuation">)</span>

  <span class="token keyword">const</span> return_code <span class="token operator">=</span> newSign<span class="token operator">===</span>paymentSign<span class="token operator">?</span><span class="token string">'SUCCESS'</span><span class="token punctuation">:</span><span class="token string">'FAIL'</span> 
  <span class="token keyword">const</span> return_msg <span class="token operator">=</span> newSign<span class="token operator">===</span>paymentSign<span class="token operator">?</span><span class="token string">'OK'</span><span class="token punctuation">:</span><span class="token string">'NO'</span> 

  <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token punctuation">{</span>
   xml<span class="token punctuation">:</span><span class="token punctuation">{</span>
    return_code<span class="token punctuation">,</span>
    return_msg
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> rs <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    compact<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付成功返回的微信的数据'</span><span class="token punctuation">,</span>rs<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> rs
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><ul><li>router/util.js 加密等方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//加密</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> getRweBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-body'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> token <span class="token operator">=</span> config<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>token

<span class="token keyword">function</span> <span class="token function">signatureAuthentication</span><span class="token punctuation">(</span><span class="token parameter">getData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>
    signature<span class="token punctuation">,</span>
    timestamp<span class="token punctuation">,</span>
    echostr<span class="token punctuation">,</span>
    nonce
  <span class="token punctuation">}</span> <span class="token operator">=</span> getData

  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token punctuation">[</span>token<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> sha <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    sha<span class="token punctuation">,</span>
    signature<span class="token punctuation">,</span>
    echostr
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sdkSignHandle</span><span class="token punctuation">(</span><span class="token parameter">noncestr<span class="token punctuation">,</span>timestamp<span class="token punctuation">,</span>ticket<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'noncestr='</span> <span class="token operator">+</span> noncestr<span class="token punctuation">,</span>
      <span class="token string">'jsapi_ticket='</span> <span class="token operator">+</span> ticket<span class="token punctuation">,</span>
      <span class="token string">'timestamp='</span> <span class="token operator">+</span> timestamp<span class="token punctuation">,</span>
      <span class="token string">'url='</span> <span class="token operator">+</span> url
  <span class="token punctuation">]</span>
  <span class="token keyword">var</span> str <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
      noncestr<span class="token punctuation">:</span> noncestr<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span>
      signature<span class="token punctuation">:</span> signature
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">transformXmlFn</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> xml <span class="token operator">=</span> data<span class="token punctuation">.</span>xml
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">in</span> xml<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> xml<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>value
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">parseXML</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// // 获取微信发过来的消息</span>
  <span class="token keyword">let</span> xml <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRweBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    length<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> <span class="token string">'1mb'</span><span class="token punctuation">,</span>
    encoding<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>charset <span class="token operator">||</span> <span class="token string">'utf-8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> xml
  <span class="token comment">// return new Promise(function (resolve, reject) {</span>
  <span class="token comment">//   let buffers = [];</span>
  <span class="token comment">//   ctx.req.on('data', function (data) {</span>
  <span class="token comment">//     buffers.push(data);</span>
  <span class="token comment">//   });</span>
  <span class="token comment">//   ctx.req.on('end', function () {</span>
  <span class="token comment">//     // let ret = Buffer.concat(buffers);</span>
  <span class="token comment">//     let ret = buffers</span>
  <span class="token comment">//     resolve(ret.toString());</span>
  <span class="token comment">//   });</span>
  <span class="token comment">// });</span>
<span class="token punctuation">}</span>
<span class="token comment">// 签名算法</span>
<span class="token keyword">function</span> <span class="token function">wxSign</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//对参数进行排序  </span>
  <span class="token keyword">let</span> sortedOrder <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> valu</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    total<span class="token punctuation">[</span>valu<span class="token punctuation">]</span> <span class="token operator">=</span> order<span class="token punctuation">[</span>valu<span class="token punctuation">]</span>
    <span class="token keyword">return</span> total
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//若是不加后面的参数 会导致结果被转换成百分比的形式</span>
  <span class="token keyword">let</span> stringifiedOrder <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sortedOrder<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    encodeURIComponent<span class="token punctuation">:</span> querystring<span class="token punctuation">.</span>unescape
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> stringifiedOrderWithKey <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stringifiedOrder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token comment">//计算签名</span>
  <span class="token keyword">let</span> sign <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stringifiedOrderWithKey<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> sign
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  signatureAuthentication<span class="token punctuation">,</span>
  sdkSignHandle<span class="token punctuation">,</span>
  transformXmlFn<span class="token punctuation">,</span>
  parseXML<span class="token punctuation">,</span>
  wxSign
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">9/4/2019, 5:39:50 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/houduan/mock.html" class="prev">
          Mockjs
        </a></span> <span class="next"><a href="/houduan/koa.html">
          koa原理
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.2d5a21ba.js" defer></script><script src="/assets/js/57.8b4691e9.js" defer></script>
  </body>
</html>
